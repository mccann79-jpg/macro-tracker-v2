<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Macro Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Macros">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileColor" content="#0d9488">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #f5f6f8;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-solid: #ffffff;
            --bg-input: #f7f8fa;
            --bg-elevated: #f0f1f4;
            --border: #e2e8f0;
            --border-strong: #cbd5e1;
            --border-focus: #0d9488;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --accent: #0d9488;
            --accent-light: #ccfbf1;
            --accent-glow: rgba(13,148,136,0.18);
            --accent-text: #0f766e;
            --accent-blue: #0d9488;
            --accent-green: #16a34a;
            --accent-amber: #d97706;
            --accent-red: #dc2626;
            --accent-purple: #7c3aed;
            --protein: #3b82f6;
            --carbs: #d97706;
            --fats: #16a34a;
            --calories: #ea580c;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --radius: 12px;
            --radius-sm: 8px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            --nav-height: 64px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            padding-top: var(--safe-top);
            padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 8px);
            -webkit-font-smoothing: antialiased;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }

        /* ===== HEADER ===== */
        .app-header {
            padding: 20px 20px 18px;
            text-align: center;
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            border-bottom: none;
            box-shadow: 0 2px 12px rgba(13, 148, 136, 0.25);
        }
        .app-header h1 {
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #ffffff;
        }

        /* ===== BOTTOM TAB NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--nav-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 9000;
        }
        .nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.65rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: color 0.2s;
            padding: 8px 4px;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }
        .nav-tab svg { width: 22px; height: 22px; transition: all 0.2s; }
        .nav-tab.active { color: var(--accent); }
        .nav-tab.active::before { content:''; position:absolute; top:0; left:50%; transform:translateX(-50%); width:20px; height:2px; background:var(--accent); border-radius:1px; }
        .nav-tab.active svg { transform: scale(1.1); }
        .nav-tab:active { opacity: 0.7; }
        @media (min-width: 860px) {
            .bottom-nav { 
                max-width: 480px; 
                left: 50%; 
                transform: translateX(-50%); 
                border-radius: 20px 20px 0 0;
                border-left: 1px solid var(--border);
                border-right: 1px solid var(--border);
            }
        }

        /* ===== PAGE CONTAINER ===== */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 16px;
        }
        .page { display: none; animation: fadeIn 0.2s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== DESKTOP GRID LAYOUTS ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .chart-cell {
            min-width: 0;
        }
        @media (min-width: 860px) {
            .container { max-width: 1100px; padding: 0 24px; }
            .charts-grid { grid-template-columns: 1fr 1fr; }
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
        }
        .card h2 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            letter-spacing: -0.01em;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .card-header h2 { margin-bottom: 0; }

        /* ===== FORMS ===== */
        .form-group { margin-bottom: 14px; }
        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 8px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.82rem;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
            -webkit-appearance: none;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        input::placeholder { color: var(--text-muted); }
        select { cursor: pointer; }
        select option { background: var(--bg-secondary); color: var(--text-primary); }
        small { color: var(--text-muted); font-size: 0.78rem; }

        /* ===== BUTTONS ===== */
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 11px 20px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-danger {
            background: #fee2e2;
            color: var(--accent-red);
            border: 1px solid #fca5a5;
            padding: 6px 12px;
            font-size: 0.8rem;
            width: auto;
        }
        .btn-success {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 7px 14px;
            font-size: 0.82rem;
            width: auto;
        }
        .btn-ghost {
            background: transparent;
            border: 1.5px solid var(--border);
            color: var(--text-secondary);
            padding: 7px 14px;
            font-size: 0.82rem;
            width: auto;
        }
        .btn-ghost:active { background: var(--bg-elevated); }
        .btn-sm { padding: 5px 10px; font-size: 0.75rem; width: auto; border-radius: 6px; }

        /* ===== DAILY TOTALS HERO ===== */
        .totals-hero {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 20px;
            margin-bottom: 12px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        .totals-hero h2 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .total-item { 
            text-align: center;
            border-right: 1px solid var(--border);
        }
        .total-item:last-child {
            border-right: none;
        }
        .total-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 6px;
        }
        .total-value {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1.6rem;
            font-weight: 600;
            line-height: 1.2;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }
        .total-remaining {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: 8px;
        }
        .total-sub {
            font-size: 0.72rem;
            margin-top: 4px;
            font-weight: 600;
        }
        .remaining-good { color: var(--accent-green); }
        .remaining-over { color: var(--accent-red); }
        .totals-actions {
            display: flex;
            gap: 8px;
            margin-top: 18px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .fiber-display {
            margin-top: 14px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ===== PROGRESS BARS ===== */
        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        /* ===== TABLES ===== */
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -20px;
            padding: 0 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        @media (min-width: 860px) {
            table { font-size: 0.85rem; }
            .table-wrap { overflow-x: visible; margin: 0; padding: 0; }
            td, th { white-space: normal; }
        }
        @media (max-width: 859px) {
            table { min-width: 520px; }
        }
        thead tr {
            background: var(--bg-elevated);
        }
        th {
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            white-space: nowrap;
        }
        th:first-child { text-align: left; }
        td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        td:first-child { text-align: left; font-weight: 600; }
        tr:last-child td { border-bottom: none; }
        .protein-col { color: var(--protein); font-weight: 600; }
        .carbs-col { color: var(--carbs); font-weight: 600; }
        .fats-col { color: var(--fats); font-weight: 600; }
        .cal-col { color: var(--calories); font-weight: 700; }

        /* ===== FOOD LIST ===== */
        .food-list { max-height: 500px; overflow-y: auto; }

        /* ===== SEARCH INPUT ===== */
        .search-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            background: var(--bg-input);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
        }
        .search-wrap {
            position: relative;
        }
        .search-wrap::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E");
            background-size: contain;
            pointer-events: none;
        }

        /* ===== DROPDOWN ===== */
        .autocomplete-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card-solid);
            border: 1.5px solid var(--border-focus);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 260px;
            overflow-y: auto;
            box-shadow: var(--shadow);
            z-index: 1000;
        }
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.1s;
        }
        .dropdown-item:active, .dropdown-item:hover {
            background: var(--accent-light);
        }
        .dropdown-item-name { font-weight: 600; font-size: 0.9rem; }
        .dropdown-item-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

        /* ===== MEAL BUILDER TABLE ===== */
        .meal-builder-table {
            min-width: 580px;
        }
        @media (min-width: 860px) {
            .meal-builder-table { min-width: 0; }
        }
        .meal-builder-table tfoot tr {
            border-top: 2px solid var(--accent);
        }
        .meal-builder-table tfoot td {
            font-weight: 700;
            font-size: 0.95rem;
            padding: 12px 8px;
        }

        /* ===== ADD-TO-DAY TOGGLE ===== */
        .toggle-group {
            display: flex;
            gap: 4px;
            background: var(--bg-input);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 14px;
        }
        .toggle-btn {
            flex: 1;
            padding: 9px 12px;
            background: none;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.82rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: var(--accent);
            color: white;
        }

        /* ===== GOALS DISPLAY ===== */
        .goals-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        .goal-chip {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        .goal-chip-protein { }
        .goal-chip-calories { }
        .goal-chip-carbs { }
        .goal-chip-fats { }

        /* ===== CHART TOGGLES ===== */
        .chart-toggles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .chart-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .chart-toggle input { margin: 0; accent-color: var(--accent); }

        /* ===== WEIGHT PAGE ===== */
        .weight-entry-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }
        .goal-weight-section {
            background: #f5f3ff;
            border: 1px solid #ddd6fe;
            padding: 18px;
            border-radius: var(--radius);
            margin-bottom: 18px;
        }
        .projection-box {
            padding: 16px;
            background: var(--bg-input);
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-top: 14px;
        }
        .projection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        .projection-label { font-size: 0.72rem; color: var(--text-muted); margin-bottom: 3px; }
        .projection-value { font-size: 1.2rem; font-weight: 700; }

        /* ===== HISTORY EDIT ROW ===== */
        .edit-row-content {
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
        }
        .edit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }

        /* ===== PIN OVERLAY ===== */
        .pin-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .pin-card {
            background: var(--bg-card-solid);
            border: 1px solid var(--border);
            padding: 36px 28px;
            border-radius: 20px;
            max-width: 360px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }
        .pin-card h2 {
            font-size: 1.3rem;
            margin-bottom: 6px;
        }
        .pin-card p {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 24px;
        }
        .pin-input {
            width: 100%;
            padding: 16px;
            font-size: 2rem;
            text-align: center;
            letter-spacing: 12px;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            background: var(--bg-input);
            border: 2px solid var(--border-focus);
            border-radius: 12px;
            color: var(--text-primary);
        }
        .pin-buttons {
            display: flex;
            gap: 8px;
            margin-top: 18px;
        }
        .pin-buttons .btn { flex: 1; }
        .pin-hint {
            margin-top: 16px;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* ===== CHART CANVAS ===== */
        canvas {
            max-width: 100%;
            border-radius: 8px;
            display: block;
        }

        /* ===== TOOLTIP ===== */
        .chart-tooltip {
            position: absolute;
            display: none;
            background: var(--bg-card-solid);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            body { padding-left: var(--safe-left); padding-right: var(--safe-right); }
            .container { padding: 0 12px; }
            .card { padding: 16px; border-radius: 14px; }
            .totals-grid { gap: 8px; }
            .total-value { font-size: 1.3rem; }
            .totals-hero { padding: 18px 14px; }
            table { font-size: 0.75rem; }
            th, td { padding: 8px 5px; }
            .btn-sm { padding: 4px 8px; font-size: 0.7rem; }
            .weight-entry-grid { grid-template-columns: 1fr 1fr; }
            .weight-entry-grid > div:last-child { grid-column: 1 / -1; }
            .projection-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 380px) {
            .totals-grid { grid-template-columns: repeat(2, 1fr); }
            .total-value { font-size: 1.5rem; }
        }
        
        /* Standalone mode (added to home screen) */
        @media (display-mode: standalone) {
            .app-header { padding-top: 8px; }
        }
    </style>
</head>
<body>

<!-- PIN Overlay -->
<div id="pinOverlay" class="pin-overlay">
    <div class="pin-card">
        <h2>üîê Enter PIN</h2>
        <p>4-digit PIN to sync data across devices</p>
        <input type="tel" id="pinInput" class="pin-input" maxlength="4" pattern="[0-9]*" placeholder="¬∑¬∑¬∑¬∑" autocomplete="off">
        <div class="pin-buttons">
            <button onclick="submitPin()" class="btn">Unlock</button>
            <button onclick="changePin()" class="btn btn-ghost" style="width:auto; flex:1;">Change</button>
        </div>
        <p class="pin-hint">First time? Enter any 4-digit PIN to create your account.</p>
    </div>
</div>

<!-- App Header -->
<div class="app-header">
    <h1>Macro Tracker</h1>
</div>

<div class="container">
    <!-- ========== FOOD DATABASE PAGE ========== -->
    <div id="databasePage" class="page active">
        <div class="card">
            <h2>Add Food</h2>
            <form id="addFoodForm">
                <input type="hidden" id="editingFoodId" value="">
                <div class="form-group">
                    <label for="foodName">Food Name</label>
                    <input type="text" id="foodName" required placeholder="e.g., Chicken Breast">
                </div>
                <div class="form-group">
                    <label>Serving Size</label>
                    <div class="form-row">
                        <input type="number" id="servingAmount" step="0.1" required min="0.1" placeholder="1">
                        <select id="servingUnit" required>
                            <option value="g">g</option>
                            <option value="oz">oz</option>
                            <option value="lb">lb</option>
                            <option value="cup">cup</option>
                            <option value="tbsp">tbsp</option>
                            <option value="tsp">tsp</option>
                            <option value="ml">ml</option>
                            <option value="fl_oz">fl oz</option>
                            <option value="piece">piece</option>
                            <option value="serving">serving</option>
                        </select>
                    </div>
                    <small>Nutrition facts per this serving size</small>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="form-group">
                        <label for="protein">Protein (g)</label>
                        <input type="number" id="protein" step="0.1" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="carbs">Carbs (g)</label>
                        <input type="number" id="carbs" step="0.1" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="fats">Fats (g)</label>
                        <input type="number" id="fats" step="0.1" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="fiber">Fiber (g) <span style="color:var(--text-muted)">(opt)</span></label>
                        <input type="number" id="fiber" step="0.1" min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="calories">Calories <span style="color:var(--text-muted)">(auto if blank)</span></label>
                    <input type="number" id="calories" step="1" min="0" placeholder="(P√ó4)+(C√ó4)+(F√ó9)">
                </div>
                <button type="submit" class="btn" id="submitFoodBtn">Add to Database</button>
                <button type="button" class="btn btn-ghost" id="cancelEditBtn" style="display:none; margin-top:8px; width:100%;" onclick="cancelEdit()">Cancel Edit</button>
            </form>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>My Foods</h2>
                <div style="display:flex; gap:6px;">
                    <button class="btn-success btn-sm" onclick="exportFoodDatabase()">‚¨á Export</button>
                    <button class="btn-success btn-sm" onclick="document.getElementById('importFileInput').click()">‚¨Ü Import</button>
                    <input type="file" id="importFileInput" accept=".csv" style="display:none;" onchange="importFoodDatabase(event)">
                </div>
            </div>
            <div class="form-group" style="margin-bottom:12px;">
                <div class="search-wrap">
                    <input type="text" id="foodSearchInput" class="search-input" placeholder="Search foods..." onkeyup="filterFoodList()">
                </div>
            </div>
            <div class="table-wrap">
                <div class="food-list" id="foodList"></div>
            </div>
        </div>
    </div>

    <!-- ========== CREATE MEAL PAGE ========== -->
    <div id="mealsPage" class="page">
        <div class="card">
            <h2 id="mealBuilderTitle">Build a Meal</h2>
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:12px; margin-bottom:16px;">
                <div class="form-group" style="margin-bottom:0;">
                    <label for="mealName">Meal Name</label>
                    <input type="text" id="mealName" placeholder="e.g., Breakfast Bowl">
                    <input type="hidden" id="editingMealId" value="">
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label for="totalServings">Servings</label>
                    <input type="number" id="totalServings" min="1" step="1" value="1">
                </div>
            </div>

            <!-- Meal Builder Table -->
            <div class="table-wrap" style="margin-bottom:16px;">
                <table class="meal-builder-table">
                    <thead>
                        <tr>
                            <th style="text-align:left; min-width:160px;">Food</th>
                            <th style="min-width:70px;">Amt</th>
                            <th style="min-width:60px;">Unit</th>
                            <th>P</th><th>C</th><th>F</th><th>Fib</th><th>Cal</th><th>P/Cal</th><th style="width:40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="mealBuilderTableBody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align:left; font-weight:700;">TOTAL</td>
                            <td class="protein-col" id="totalProteinTable">0g</td>
                            <td class="carbs-col" id="totalCarbsTable">0g</td>
                            <td class="fats-col" id="totalFatsTable">0g</td>
                            <td id="totalFiberTable">0g</td>
                            <td class="cal-col" id="totalCaloriesTable">0</td>
                            <td id="totalPCalTable">0</td>
                            <td></td>
                        </tr>
                        <tr style="opacity:0.7;">
                            <td colspan="3" style="text-align:left; font-weight:600; color:var(--accent-blue);">PER SERVING</td>
                            <td class="protein-col" id="perServingProteinTable">0g</td>
                            <td class="carbs-col" id="perServingCarbsTable">0g</td>
                            <td class="fats-col" id="perServingFatsTable">0g</td>
                            <td id="perServingFiberTable">0g</td>
                            <td class="cal-col" id="perServingCaloriesTable">0</td>
                            <td id="perServingPCalTable">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Add Food to Meal -->
            <div style="background:var(--bg-input); padding:14px; border-radius:10px; margin-bottom:16px;">
                <div style="display:grid; grid-template-columns:3fr 1fr; gap:8px;">
                    <div class="form-group" style="margin-bottom:0; position:relative;">
                        <label for="searchFoodForMeal">Add Food</label>
                        <input type="text" id="searchFoodForMeal" placeholder="Type to search..."
                            onfocus="showMealFoodDropdown()"
                            onkeyup="filterMealFoodDropdownCustom()"
                            onkeydown="handleMealFoodKeydown(event)"
                            autocomplete="off">
                        <div id="mealFoodDropdown" class="autocomplete-dropdown"></div>
                        <input type="hidden" id="selectedFoodForMeal" value="">
                    </div>
                    <div style="display:flex; align-items:flex-end;">
                        <button type="button" class="btn" id="addToMealBuilder" style="width:100%;">+ Add</button>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:8px;">
                <button type="button" class="btn" id="saveMealBtn" style="flex:1;">Save Meal</button>
                <button type="button" class="btn btn-ghost" id="cancelMealEditBtn" style="flex:1; display:none; width:100%;" onclick="cancelMealEdit()">Cancel</button>
            </div>
        </div>

        <!-- Saved Meals -->
        <div class="card">
            <div class="card-header">
                <h2>Saved Meals</h2>
                <div style="display:flex; gap:6px;">
                    <button class="btn-success btn-sm" onclick="exportSavedMeals()">‚¨á Export</button>
                    <button class="btn-success btn-sm" onclick="document.getElementById('importMealsInput').click()">‚¨Ü Import</button>
                    <input type="file" id="importMealsInput" accept=".csv" style="display:none;" onchange="importSavedMeals(event)">
                </div>
            </div>
            <div class="table-wrap">
                <div id="savedMealsList"></div>
            </div>
        </div>
    </div>

    <!-- ========== MY DAY PAGE ========== -->
    <div id="dayPage" class="page">
        <!-- Daily Totals Hero -->
        <div class="totals-hero">
            <h2>Daily Totals</h2>
            <div class="totals-grid">
                <div class="total-item">
                    <div class="total-label">Protein (g)</div>
                    <div class="total-value" id="dayProtein">0</div>
                    <div class="total-remaining" id="remainingProtein"></div>
                    <div class="progress-bar-container"><div class="progress-bar-fill" id="proteinBar" style="background:var(--protein); width:0%;"></div></div>
                </div>
                <div class="total-item">
                    <div class="total-label">Carbs (g)</div>
                    <div class="total-value" id="dayCarbs">0</div>
                    <div class="total-remaining" id="remainingCarbs"></div>
                    <div class="progress-bar-container"><div class="progress-bar-fill" id="carbsBar" style="background:var(--carbs); width:0%;"></div></div>
                </div>
                <div class="total-item">
                    <div class="total-label">Fats (g)</div>
                    <div class="total-value" id="dayFats">0</div>
                    <div class="total-remaining" id="remainingFats"></div>
                    <div class="progress-bar-container"><div class="progress-bar-fill" id="fatsBar" style="background:var(--fats); width:0%;"></div></div>
                </div>
                <div class="total-item">
                    <div class="total-label">Calories</div>
                    <div class="total-value" id="dayCalories">0</div>
                    <div class="total-remaining" id="remainingCalories"></div>
                    <div class="progress-bar-container"><div class="progress-bar-fill" id="caloriesBar" style="background:var(--calories); width:0%;"></div></div>
                </div>
            </div>
            <div class="fiber-display">Fiber: <strong id="dayFiber">0</strong>g</div>
            
            <!-- Goals Display -->
            <div id="goalsDisplay" style="display:none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div class="goals-grid">
                    <div class="goal-chip goal-chip-protein">Protein: <span id="displayGoalProtein">0</span>g</div>
                    <div class="goal-chip goal-chip-carbs" id="displayGoalCarbsContainer" style="display:none;">Carbs: <span id="displayGoalCarbs">0</span>g</div>
                    <div class="goal-chip goal-chip-fats" id="displayGoalFatsContainer" style="display:none;">Fats: <span id="displayGoalFats">0</span>g</div>
                    <div class="goal-chip goal-chip-calories">Cal: <span id="displayGoalCalories">0</span></div>
                    <button class="btn-ghost btn-sm" onclick="toggleGoalsEdit()" style="margin-left: 8px;">
                        <span id="goalsEditBtnText">Edit</span>
                    </button>
                </div>
            </div>
            <div id="goalsForm" style="display:none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="goalProtein">Protein (g) *</label>
                        <input type="number" id="goalProtein" min="0" step="1" placeholder="150">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="goalCalories">Calories *</label>
                        <input type="number" id="goalCalories" min="0" step="1" placeholder="2000">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="goalCarbs">Carbs (g) <span style="color:var(--text-muted)">opt</span></label>
                        <input type="number" id="goalCarbs" min="0" step="1" placeholder="‚Äî">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="goalFats">Fats (g) <span style="color:var(--text-muted)">opt</span></label>
                        <input type="number" id="goalFats" min="0" step="1" placeholder="‚Äî">
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn" onclick="saveGoals()" style="flex:1;">Save Goals</button>
                    <button class="btn btn-danger" onclick="clearGoals()" style="flex:0;">Clear</button>
                </div>
            </div>
            
            <div class="totals-actions">
                <input type="date" id="closeOutDate" style="padding:7px 10px; background:var(--bg-input); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-family:inherit; font-size:0.8rem;">
                <button class="btn-success btn-sm" onclick="closeOutDay()">üìä Close Out</button>
                <button class="btn-danger btn-sm" id="clearDayBtn" onclick="clearDay()">Clear Day</button>
                <button class="btn-success btn-sm" id="undoClearBtn" onclick="undoClear()" style="display:none;">Undo</button>
            </div>
        </div>

        <!-- Add to Day -->
        <div class="card">
            <h2>Add to Today</h2>
            <div style="display:flex; gap:12px; margin-bottom:12px;">
                <label class="chart-toggle" style="margin:0;"><input type="checkbox" id="filterMeals" checked onchange="filterUnifiedDropdown()"> Meals</label>
                <label class="chart-toggle" style="margin:0;"><input type="checkbox" id="filterFoods" checked onchange="filterUnifiedDropdown()"> Foods</label>
            </div>

            <div class="form-group" style="position:relative;">
                <label for="searchItemForDay">Search meals & foods</label>
                <input type="text" id="searchItemForDay" placeholder="Type to search..."
                    onfocus="filterUnifiedDropdown()"
                    onkeyup="filterUnifiedDropdown()"
                    autocomplete="off">
                <div id="dayUnifiedDropdown" class="autocomplete-dropdown"></div>
                <input type="hidden" id="selectedItemName" value="">
                <input type="hidden" id="selectedItemType" value="">
            </div>
            <div class="form-group">
                <label>Amount</label>
                <div class="form-row">
                    <input type="number" id="itemAmountForDay" min="0.1" step="0.1" value="1">
                    <select id="itemUnitForDay">
                        <option value="serving">servings</option>
                        <option value="g">g</option>
                        <option value="oz">oz</option>
                        <option value="lb">lb</option>
                        <option value="cup">cup</option>
                        <option value="tbsp">tbsp</option>
                        <option value="tsp">tsp</option>
                        <option value="ml">ml</option>
                        <option value="fl_oz">fl oz</option>
                        <option value="piece">piece</option>
                    </select>
                </div>
            </div>
            <button class="btn" id="addItemToDay">Add to Day</button>
        </div>

        <!-- Today's Meals -->
        <div class="card">
            <h2>Today's Meals</h2>
            <div class="table-wrap">
                <div id="dayMealsList"></div>
            </div>
        </div>

        <!-- History -->
        <div class="card">
            <div class="card-header">
                <h2>History</h2>
                <div style="display:flex; gap:6px;">
                    <button class="btn-success btn-sm" onclick="exportHistory()">‚¨á Export</button>
                    <button class="btn-success btn-sm" onclick="document.getElementById('importHistoryInput').click()">‚¨Ü Import</button>
                    <input type="file" id="importHistoryInput" accept=".csv" style="display:none;" onchange="importHistory(event)">
                </div>
            </div>
            <div class="chart-toggles">
                <label class="chart-toggle"><input type="checkbox" id="showDailyBars" checked onchange="redrawAllCharts()"> üìä Bars</label>
                <label class="chart-toggle"><input type="checkbox" id="show7DayAvg" checked onchange="redrawAllCharts()"> üìà 7d Avg</label>
                <label class="chart-toggle"><input type="checkbox" id="showGoalLine" checked onchange="redrawAllCharts()"> üéØ Goal</label>
            </div>

            <div class="charts-grid">
                <div class="chart-cell">
                    <h3 style="color:var(--protein); font-size:0.9rem; margin-bottom:8px;">Protein</h3>
                    <canvas id="proteinChart" width="400" height="200"></canvas>
                    <div id="proteinStats" style="margin-top:8px;"></div>
                </div>
                <div class="chart-cell">
                    <h3 style="color:var(--calories); font-size:0.9rem; margin-bottom:8px;">Calories</h3>
                    <canvas id="calorieChart" width="400" height="200"></canvas>
                    <div id="calorieStats" style="margin-top:8px;"></div>
                </div>
                <div class="chart-cell">
                    <h3 style="color:var(--carbs); font-size:0.9rem; margin-bottom:8px;">Carbs</h3>
                    <canvas id="carbsChart" width="400" height="200"></canvas>
                    <div id="carbsStats" style="margin-top:8px;"></div>
                </div>
                <div class="chart-cell">
                    <h3 style="color:var(--fats); font-size:0.9rem; margin-bottom:8px;">Fats</h3>
                    <canvas id="fatsChart" width="400" height="200"></canvas>
                    <div id="fatsStats" style="margin-top:8px;"></div>
                </div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align:left;">Date</th><th>Cal</th><th>Goal</th><th>Protein</th><th>Goal</th><th>Carbs</th><th>Fats</th><th></th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
            <div id="emptyHistoryMessage" class="empty-state" style="display:none;">No history yet. Click "Close Out" to save today's data.</div>
        </div>
    </div>

    <!-- ========== WEIGHT PAGE ========== -->
    <div id="weightPage" class="page">
        <div class="card">
            <div class="card-header">
                <h2>Add Weight</h2>
                <div style="display:flex; gap:6px;">
                    <button class="btn-success btn-sm" onclick="exportWeightData()">‚¨á Export</button>
                    <button class="btn-success btn-sm" onclick="document.getElementById('importWeightInput').click()">‚¨Ü Import</button>
                    <input type="file" id="importWeightInput" accept=".csv" style="display:none;" onchange="importWeightData(event)">
                </div>
            </div>
            <div class="weight-entry-grid">
                <div class="form-group" style="margin-bottom:0;">
                    <label for="weightDate">Date</label>
                    <input type="date" id="weightDate" required>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label for="morningWeight">Weight (lb)</label>
                    <input type="number" id="morningWeight" step="0.1" placeholder="196.5" required>
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button class="btn" onclick="addWeightEntry()" style="padding:10px 16px;">+ Add</button>
                </div>
            </div>
            <div class="form-group" style="margin-top:10px; margin-bottom:0;">
                <label for="weightNotes">Notes <span style="color:var(--text-muted)">(optional)</span></label>
                <input type="text" id="weightNotes" placeholder="e.g., creatine loading">
            </div>
        </div>

        <div class="card">
            <h2>Weight Trends</h2>
            <div class="goal-weight-section">
                <label style="font-weight:700; color:var(--accent-purple); margin-bottom:10px; display:block;">Goal Weight</label>
                <div style="display:flex; gap:8px; align-items:stretch; flex-wrap:wrap;">
                    <input type="number" id="goalWeight" step="0.1" placeholder="e.g., 185" style="flex:1; min-width:120px;">
                    <button class="btn" onclick="setGoalWeight()" style="padding:10px 18px; width:auto;">Set</button>
                    <button class="btn btn-danger" onclick="clearGoalWeight()" style="padding:10px 14px;">Clear</button>
                </div>
                <div id="goalProjection" class="projection-box" style="display:none;">
                    <div style="font-size:0.82rem; color:var(--text-muted); margin-bottom:10px; font-weight:600;">üìä Based on your trend:</div>
                    <div class="projection-grid">
                        <div><div class="projection-label">Target</div><div class="projection-value" style="color:var(--accent-purple);" id="targetWeight">185 lb</div></div>
                        <div><div class="projection-label">Projected Date</div><div class="projection-value" style="color:var(--accent-green);" id="projectedDate">‚Äî</div></div>
                        <div><div class="projection-label">Time Left</div><div class="projection-value" style="color:var(--accent-amber);" id="projectedDays">‚Äî</div></div>
                    </div>
                    <div style="padding-top:10px; border-top:1px solid var(--border); margin-top:10px;">
                        <div style="font-size:0.82rem; color:var(--text-muted);" id="weightToGo"></div>
                        <div style="font-size:0.82rem; color:var(--text-muted);" id="trendRate"></div>
                    </div>
                </div>
            </div>

            <div class="chart-toggles" style="margin-bottom:12px;">
                <label class="chart-toggle"><input type="checkbox" id="showMorningWeight" checked onchange="drawWeightChart()"> <span style="color:var(--protein);">Weight</span></label>
                <label class="chart-toggle"><input type="checkbox" id="showWeeklyAvg" checked onchange="drawWeightChart()"> <span style="color:var(--accent-green);">7d Avg</span></label>
                <label class="chart-toggle"><input type="checkbox" id="showTrendLine" checked onchange="drawWeightChart()"> <span style="color:var(--accent-red);">Trend</span></label>
                <label class="chart-toggle"><input type="checkbox" id="showCalories" onchange="drawWeightChart()"> <span style="color:var(--accent-amber);">Calories</span></label>
            </div>
            <div class="chart-cell">
                <canvas id="weightChart" style="cursor:crosshair; width:100%;"></canvas>
            </div>
            <div id="weightChartTooltip" class="chart-tooltip"></div>
        </div>

        <div class="card">
            <h2>Weight Log</h2>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align:left;">Date</th><th>Weight</th><th>7d Avg</th><th>Change</th><th style="text-align:left;">Notes</th><th></th>
                        </tr>
                    </thead>
                    <tbody id="weightTableBody"></tbody>
                </table>
            </div>
            <div id="emptyWeightMessage" class="empty-state" style="display:none;">No weight entries yet.</div>
        </div>
    </div>
</div>

<!-- Bottom Tab Navigation -->
<nav class="bottom-nav">
    <button class="nav-tab active" onclick="showPage('database', this)" id="tab-database">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
        Foods
    </button>
    <button class="nav-tab" onclick="showPage('meals', this)" id="tab-meals">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
        Meals
    </button>
    <button class="nav-tab" onclick="showPage('day', this)" id="tab-day">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        My Day
    </button>
    <button class="nav-tab" onclick="showPage('weight', this)" id="tab-weight">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        Weight
    </button>
</nav>

    <script>
        // Helper: get today's date in YYYY-MM-DD using LOCAL timezone (not UTC)
        function getLocalDateString(date) {
            const d = date || new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // INSTRUCTIONS: Replace these values with your own Firebase project config.
        // 1. Go to https://console.firebase.google.com
        // 2. Create a new project (or use existing)
        // 3. Go to Project Settings > General > Your apps > Add web app
        // 4. Copy the config values below
        // 5. Go to Realtime Database > Create Database > Start in test mode
        // 6. Update the rules to: { "rules": { ".read": true, ".write": true } }
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyDTnUJ2w1cIwvWZF6BuKKPsUFf3v8etQyU",
          authDomain: "macro-tracker-v2.firebaseapp.com",
          databaseURL: "https://macro-tracker-v2-default-rtdb.firebaseio.com",
          projectId: "macro-tracker-v2",
          storageBucket: "macro-tracker-v2.firebasestorage.app",
          messagingSenderId: "232651934092",
          appId: "1:232651934092:web:586b1469ab0f8c4718eea9",
          measurementId: "G-20V1XK4HTB"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let userPin = localStorage.getItem('userPin') || null;
        let firebaseRef = null;

        // Unit conversion constants (to grams or ml)
        const UNIT_CONVERSIONS = {
            'g': 1,
            'oz': 28.3495,
            'lb': 453.592,
            'cup': 240,  // ml for liquids, varies for solids
            'tbsp': 15,  // ml
            'tsp': 5,    // ml
            'ml': 1,
            'fl_oz': 29.5735,
            'piece': 1,  // individual items (eggs, apples, etc.)
            'serving': 1  // placeholder, user defines the weight
        };

        const UNIT_LABELS = {
            'g': 'g',
            'oz': 'oz',
            'lb': 'lb',
            'cup': 'cup',
            'tbsp': 'tbsp',
            'tsp': 'tsp',
            'ml': 'ml',
            'fl_oz': 'fl oz',
            'piece': 'piece',
            'serving': 'serving'
        };

        // Data storage
        let foodDatabase = JSON.parse(localStorage.getItem('foodDatabase')) || [];
        let savedMeals = JSON.parse(localStorage.getItem('savedMeals')) || [];
        let currentMealBuilder = [];
        let todaysMeals = JSON.parse(localStorage.getItem('todaysMeals')) || [];
        let clearedMealsBackup = null; // For undo functionality
        let dailyGoals = JSON.parse(localStorage.getItem('dailyGoals')) || null;
        let dayHistory = JSON.parse(localStorage.getItem('dayHistory')) || [];
        let weightData = JSON.parse(localStorage.getItem('weightData')) || [];
        let goalWeight = localStorage.getItem('goalWeight') ? parseFloat(localStorage.getItem('goalWeight')) : null;

        // CLEANUP: Remove any invalid entries from dayHistory (like meal objects that got mixed in)
        const originalHistoryLength = dayHistory.length;
        dayHistory = dayHistory.filter(entry => {
            // Keep only entries with valid YYYY-MM-DD dates
            return entry.date && /^\d{4}-\d{2}-\d{2}$/.test(entry.date) && typeof entry.calories === 'number';
        });
        
        if (dayHistory.length < originalHistoryLength) {
            console.log(`üßπ Cleaned up history: removed ${originalHistoryLength - dayHistory.length} invalid entries`);
            localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
        }

        // Load sample data if empty (for testing)
        if (foodDatabase.length === 0) {
            foodDatabase = [
                { name: "Chicken Breast", servingAmount: 100, servingUnit: "g", protein: 31, carbs: 0, fats: 3.6, fiber: 0, calories: 165 },
                { name: "Brown Rice", servingAmount: 100, servingUnit: "g", protein: 2.6, carbs: 23, fats: 0.9, fiber: 1.8, calories: 112 },
                { name: "Broccoli", servingAmount: 100, servingUnit: "g", protein: 2.8, carbs: 7, fats: 0.4, fiber: 2.6, calories: 34 },
                { name: "Salmon", servingAmount: 100, servingUnit: "g", protein: 20, carbs: 0, fats: 13, fiber: 0, calories: 208 },
                { name: "Sweet Potato", servingAmount: 100, servingUnit: "g", protein: 1.6, carbs: 20, fats: 0.1, fiber: 3, calories: 86 },
                { name: "Egg", servingAmount: 1, servingUnit: "piece", protein: 6, carbs: 0.6, fats: 5, fiber: 0, calories: 78 },
                { name: "Greek Yogurt", servingAmount: 100, servingUnit: "g", protein: 10, carbs: 3.6, fats: 0.4, fiber: 0, calories: 59 },
                { name: "Oats", servingAmount: 40, servingUnit: "g", protein: 5, carbs: 27, fats: 3, fiber: 4, calories: 152 },
                { name: "Banana", servingAmount: 1, servingUnit: "piece", protein: 1.3, carbs: 27, fats: 0.4, fiber: 3.1, calories: 105 },
                { name: "Almonds", servingAmount: 28, servingUnit: "g", protein: 6, carbs: 6, fats: 14, fiber: 3.5, calories: 164 },
                { name: "Whey Protein", servingAmount: 30, servingUnit: "g", protein: 24, carbs: 3, fats: 1.5, fiber: 0, calories: 120 },
                { name: "Olive Oil", servingAmount: 1, servingUnit: "tbsp", protein: 0, carbs: 0, fats: 14, fiber: 0, calories: 119 },
                { name: "Avocado", servingAmount: 100, servingUnit: "g", protein: 2, carbs: 9, fats: 15, fiber: 7, calories: 160 },
                { name: "Ground Beef (90/10)", servingAmount: 100, servingUnit: "g", protein: 26, carbs: 0, fats: 10, fiber: 0, calories: 176 },
                { name: "White Rice", servingAmount: 100, servingUnit: "g", protein: 2.7, carbs: 28, fats: 0.3, fiber: 0.4, calories: 130 }
            ];
            localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
            console.log('‚úÖ Loaded 15 sample foods');
        }

        if (savedMeals.length === 0) {
            savedMeals = [
                {
                    id: Date.now(),
                    name: "Breakfast Protein Bowl",
                    totalServings: 1,
                    foods: [
                        { name: "Oats", servingAmount: 40, servingUnit: "g", protein: 5, carbs: 27, fats: 3, fiber: 4, calories: 152, amount: 50, unit: "g" },
                        { name: "Greek Yogurt", servingAmount: 100, servingUnit: "g", protein: 10, carbs: 3.6, fats: 0.4, fiber: 0, calories: 59, amount: 150, unit: "g" },
                        { name: "Banana", servingAmount: 1, servingUnit: "piece", protein: 1.3, carbs: 27, fats: 0.4, fiber: 3.1, calories: 105, amount: 1, unit: "piece" },
                        { name: "Whey Protein", servingAmount: 30, servingUnit: "g", protein: 24, carbs: 3, fats: 1.5, fiber: 0, calories: 120, amount: 30, unit: "g" }
                    ],
                    perServing: { protein: 51.3, carbs: 68.4, fats: 6.5, fiber: 11.1, calories: 526 }
                },
                {
                    id: Date.now() + 1,
                    name: "Chicken & Rice",
                    totalServings: 1,
                    foods: [
                        { name: "Chicken Breast", servingAmount: 100, servingUnit: "g", protein: 31, carbs: 0, fats: 3.6, fiber: 0, calories: 165, amount: 150, unit: "g" },
                        { name: "Brown Rice", servingAmount: 100, servingUnit: "g", protein: 2.6, carbs: 23, fats: 0.9, fiber: 1.8, calories: 112, amount: 200, unit: "g" },
                        { name: "Broccoli", servingAmount: 100, servingUnit: "g", protein: 2.8, carbs: 7, fats: 0.4, fiber: 2.6, calories: 34, amount: 100, unit: "g" },
                        { name: "Olive Oil", servingAmount: 1, servingUnit: "tbsp", protein: 0, carbs: 0, fats: 14, fiber: 0, calories: 119, amount: 1, unit: "tbsp" }
                    ],
                    perServing: { protein: 53.3, carbs: 53, fats: 20.3, fiber: 6.2, calories: 598 }
                },
                {
                    id: Date.now() + 2,
                    name: "Salmon Dinner",
                    totalServings: 1,
                    foods: [
                        { name: "Salmon", servingAmount: 100, servingUnit: "g", protein: 20, carbs: 0, fats: 13, fiber: 0, calories: 208, amount: 150, unit: "g" },
                        { name: "Sweet Potato", servingAmount: 100, servingUnit: "g", protein: 1.6, carbs: 20, fats: 0.1, fiber: 3, calories: 86, amount: 200, unit: "g" },
                        { name: "Broccoli", servingAmount: 100, servingUnit: "g", protein: 2.8, carbs: 7, fats: 0.4, fiber: 2.6, calories: 34, amount: 150, unit: "g" }
                    ],
                    perServing: { protein: 36.2, carbs: 50.5, fats: 20.1, fiber: 8.9, calories: 518 }
                }
            ];
            localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
            console.log('‚úÖ Loaded 3 sample meals');
        }

        if (!dailyGoals) {
            dailyGoals = {
                protein: 165,
                calories: 2100,
                carbs: 200,
                fats: 60
            };
            localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
            console.log('‚úÖ Loaded sample daily goals');
        }

        // PIN and Firebase Sync Functions
        function showPinOverlay() {
            document.getElementById('pinOverlay').style.display = 'flex';
            document.getElementById('pinInput').focus();
        }

        function hidePinOverlay() {
            document.getElementById('pinOverlay').style.display = 'none';
        }

        function submitPin() {
            const pin = document.getElementById('pinInput').value.trim();
            
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                alert('Please enter a valid 4-digit PIN');
                return;
            }

            userPin = pin;
            localStorage.setItem('userPin', userPin);
            
            // Connect to Firebase with this PIN
            connectToFirebase();
            hidePinOverlay();
        }

        function changePin() {
            if (confirm('Change PIN? This will disconnect you from your current data.')) {
                localStorage.removeItem('userPin');
                userPin = null;
                if (firebaseRef) {
                    firebaseRef.off(); // Disconnect listeners
                }
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').focus();
            }
        }

        function connectToFirebase() {
            if (!userPin) return;

            // Reference to this user's data in Firebase
            firebaseRef = database.ref(userPin);

            // Load data from Firebase
            firebaseRef.once('value', (snapshot) => {
                const data = snapshot.val();
                
                console.log('üì° Firebase data loaded:', data ? 'has data' : 'empty');
                
                if (data) {
                    // Check what's in cloud vs local
                    const cloudFoods = data.foodDatabase ? data.foodDatabase.length : 0;
                    const cloudMeals = data.savedMeals ? data.savedMeals.length : 0;
                    const cloudToday = data.todaysMeals ? data.todaysMeals.length : 0;
                    const cloudHistory = data.dayHistory ? data.dayHistory.length : 0;
                    const cloudWeight = data.weightData ? data.weightData.length : 0;
                    
                    const localFoods = foodDatabase.length;
                    const localMeals = savedMeals.length;
                    const localToday = todaysMeals.length;
                    const localHistory = dayHistory.length;
                    const localWeight = weightData.length;
                    
                    console.log('‚òÅÔ∏è Cloud has:', {foods: cloudFoods, meals: cloudMeals, today: cloudToday, history: cloudHistory, weight: cloudWeight});
                    console.log('üíæ Local has:', {foods: localFoods, meals: localMeals, today: localToday, history: localHistory, weight: localWeight});
                    
                    // Only load from cloud if cloud has more data than local
                    let loadedFromCloud = false;
                    
                    if (cloudFoods > localFoods && data.foodDatabase) {
                        console.log('‚¨áÔ∏è Loading foods from cloud');
                        foodDatabase = data.foodDatabase;
                        localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                        loadedFromCloud = true;
                    }
                    
                    if (cloudMeals > localMeals && data.savedMeals) {
                        console.log('‚¨áÔ∏è Loading meals from cloud');
                        savedMeals = data.savedMeals;
                        localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
                        loadedFromCloud = true;
                    }
                    
                    if (cloudToday > localToday && data.todaysMeals) {
                        console.log('‚¨áÔ∏è Loading today meals from cloud');
                        todaysMeals = data.todaysMeals;
                        localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                        loadedFromCloud = true;
                    }
                    
                    if (cloudHistory > localHistory && data.dayHistory) {
                        console.log('‚¨áÔ∏è Loading history from cloud');
                        dayHistory = data.dayHistory;
                        localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
                        loadedFromCloud = true;
                    }
                    
                    if (cloudWeight > localWeight && data.weightData) {
                        console.log('‚¨áÔ∏è Loading weight data from cloud');
                        weightData = data.weightData;
                        localStorage.setItem('weightData', JSON.stringify(weightData));
                        loadedFromCloud = true;
                    }
                    
                    if (data.dailyGoals) {
                        dailyGoals = data.dailyGoals;
                        localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
                    }
                    
                    if (loadedFromCloud) {
                        console.log('‚úÖ Loaded newer data from cloud');
                        // Refresh UI with loaded data
                        renderFoodList();
                        updateFoodSelectors();
                        renderSavedMeals();
                        updateMealSelector();
                        renderDayMeals();
                        calculateDayTotals();
                        displayGoals();
                        renderHistory();
                        drawHistoryChart();
                        renderWeightTable();
                        drawWeightChart();
                    } else if (localFoods > 0 || localMeals > 0 || localWeight > 0) {
                        // Local has more data - sync it to cloud
                        console.log('‚¨ÜÔ∏è Local has more data - syncing to cloud');
                        syncToFirebase();
                    }
                } else {
                    // No data in cloud - check if we have local data to upload
                    if (foodDatabase.length > 0 || savedMeals.length > 0 || weightData.length > 0) {
                        console.log('‚¨ÜÔ∏è Uploading local data to cloud');
                        syncToFirebase();
                    }
                }
            });

            // Listen for changes from other devices
            firebaseRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data._lastSync) {
                    const localLastSync = parseInt(localStorage.getItem('lastSync') || '0');
                    if (data._lastSync > localLastSync) {
                        console.log('üîÑ Remote data is newer - updating local');
                        // Remote data is newer - update local
                        if (data.foodDatabase) {
                            foodDatabase = data.foodDatabase;
                            localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                            renderFoodList();
                            updateFoodSelectors();
                        }
                        if (data.savedMeals) {
                            savedMeals = data.savedMeals;
                            localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
                            renderSavedMeals();
                            updateMealSelector();
                        }
                        if (data.todaysMeals) {
                            todaysMeals = data.todaysMeals;
                            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                            renderDayMeals();
                        }
                        if (data.dailyGoals !== undefined) {
                            dailyGoals = data.dailyGoals;
                            localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
                            displayGoals();
                        }
                        if (data.dayHistory) {
                            dayHistory = data.dayHistory;
                            localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
                            renderHistory();
                            drawHistoryChart();
                        }
                        if (data.weightData) {
                            weightData = data.weightData;
                            localStorage.setItem('weightData', JSON.stringify(weightData));
                            renderWeightTable();
                            drawWeightChart();
                        }
                        localStorage.setItem('lastSync', data._lastSync.toString());
                    }
                }
            });
        }

        function syncToFirebase() {
            if (!userPin || !firebaseRef) return;

            const timestamp = Date.now();
            
            // Helper function to clean NaN values from objects
            const cleanNaN = (obj) => {
                if (obj === null || obj === undefined) return obj;
                if (typeof obj !== 'object') {
                    return isNaN(obj) ? null : obj;
                }
                if (Array.isArray(obj)) {
                    return obj.map(item => cleanNaN(item));
                }
                const cleaned = {};
                for (let key in obj) {
                    const value = obj[key];
                    if (typeof value === 'number' && isNaN(value)) {
                        cleaned[key] = null;
                    } else if (typeof value === 'object') {
                        cleaned[key] = cleanNaN(value);
                    } else {
                        cleaned[key] = value;
                    }
                }
                return cleaned;
            };
            
            firebaseRef.set({
                foodDatabase: cleanNaN(foodDatabase),
                savedMeals: cleanNaN(savedMeals),
                todaysMeals: cleanNaN(todaysMeals),
                dailyGoals: cleanNaN(dailyGoals),
                dayHistory: cleanNaN(dayHistory),
                weightData: cleanNaN(weightData),
                _lastSync: timestamp
            }).then(() => {
                localStorage.setItem('lastSync', timestamp.toString());
            }).catch((error) => {
                console.error('Sync error:', error);
                alert('Sync failed: ' + error.message + '\n\nYour data is saved locally, but could not sync to cloud.');
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // EMERGENCY: Check if data exists but UI isn't showing it
            console.log('üîç Checking data on load...');
            console.log('Foods in database:', foodDatabase.length);
            console.log('Saved meals:', savedMeals.length);
            console.log('Today meals:', todaysMeals.length);
            console.log('Weight data:', weightData.length);
            console.log('History:', dayHistory.length);
            
            // If data is empty but localStorage has it, recover
            if (foodDatabase.length === 0) {
                const storedFoods = localStorage.getItem('foodDatabase');
                if (storedFoods) {
                    console.log('‚ö†Ô∏è Food database empty but localStorage has data - recovering...');
                    foodDatabase = JSON.parse(storedFoods);
                }
            }
            
            if (savedMeals.length === 0) {
                const storedMeals = localStorage.getItem('savedMeals');
                if (storedMeals) {
                    console.log('‚ö†Ô∏è Saved meals empty but localStorage has data - recovering...');
                    savedMeals = JSON.parse(storedMeals);
                }
            }
            
            if (todaysMeals.length === 0) {
                const storedToday = localStorage.getItem('todaysMeals');
                if (storedToday) {
                    console.log('‚ö†Ô∏è Today meals empty but localStorage has data - recovering...');
                    todaysMeals = JSON.parse(storedToday);
                }
            }
            
            if (weightData.length === 0) {
                const storedWeight = localStorage.getItem('weightData');
                if (storedWeight) {
                    console.log('‚ö†Ô∏è Weight data empty but localStorage has data - recovering...');
                    weightData = JSON.parse(storedWeight);
                }
            }
            
            if (dayHistory.length === 0) {
                const storedHistory = localStorage.getItem('dayHistory');
                if (storedHistory) {
                    console.log('‚ö†Ô∏è Day history empty but localStorage has data - recovering...');
                    dayHistory = JSON.parse(storedHistory);
                }
            }
            
            console.log('‚úÖ After recovery check:');
            console.log('Foods:', foodDatabase.length);
            console.log('Meals:', savedMeals.length);
            console.log('Today:', todaysMeals.length);
            console.log('Weight:', weightData.length);
            console.log('History:', dayHistory.length);
            
            // Check if user has a PIN
            if (!userPin) {
                showPinOverlay();
            } else {
                connectToFirebase();
            }

            renderFoodList();
            updateFoodSelectors();
            renderSavedMeals();
            updateMealSelector();
            renderDayMeals();
            calculateDayTotals();
            displayGoals();
            renderHistory();
            drawHistoryChart();
            renderWeightTable();
            drawWeightChart();
            loadGoalWeight();
            
            // Set today's date as default for close out and weight entry
            const today = getLocalDateString();
            document.getElementById('closeOutDate').value = today;
            document.getElementById('weightDate').value = today;
            
            // Event listeners
            document.getElementById('addFoodForm').addEventListener('submit', addFood);
            document.getElementById('addToMealBuilder').addEventListener('click', addFoodToMealBuilder);
            document.getElementById('saveMealBtn').addEventListener('click', saveMeal);
            document.getElementById('addItemToDay').addEventListener('click', addItemToDay);
            document.getElementById('totalServings').addEventListener('input', calculateMealTotals);
            
            // Update food selector for day page
            updateDayFoodSelector();
            
            // PIN input - submit on Enter key
            document.getElementById('pinInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPin();
                }
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                // Close meal food dropdown
                if (!e.target.closest('#searchFoodForMeal') && !e.target.closest('#mealFoodDropdown')) {
                    const dropdown = document.getElementById('mealFoodDropdown');
                    if (dropdown) dropdown.style.display = 'none';
                }
                
                // Close day meal dropdown
                if (!e.target.closest('#searchItemForDay') && !e.target.closest('#dayUnifiedDropdown')) {
                    const dropdown = document.getElementById('dayUnifiedDropdown');
                    if (dropdown) dropdown.style.display = 'none';
                }
            });
        });

        function showPage(pageName, tabEl) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            
            // Show selected page
            document.getElementById(pageName + 'Page').classList.add('active');
            
            // Activate clicked tab
            if (tabEl) {
                tabEl.classList.add('active');
            } else {
                const tab = document.getElementById('tab-' + pageName);
                if (tab) tab.classList.add('active');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Redraw charts when switching to relevant pages
            if (pageName === 'weight') {
                setTimeout(() => drawWeightChart(), 100);
            }
            if (pageName === 'day') {
                setTimeout(() => { drawHistoryChart(); }, 100);
            }
        }

        // Convert any unit to grams/ml equivalent
        function convertToBaseUnit(amount, unit) {
            return amount * (UNIT_CONVERSIONS[unit] || 1);
        }

        // Convert from base unit back to specific unit
        function convertFromBaseUnit(baseAmount, unit) {
            return baseAmount / (UNIT_CONVERSIONS[unit] || 1);
        }

        function addFood(e) {
            e.preventDefault();
            
            const fiberValue = parseFloat(document.getElementById('fiber').value) || 0;
            const editingId = document.getElementById('editingFoodId').value;
            const servingAmount = parseFloat(document.getElementById('servingAmount').value);
            const servingUnit = document.getElementById('servingUnit').value;
            
            const protein = parseFloat(document.getElementById('protein').value);
            const carbs = parseFloat(document.getElementById('carbs').value);
            const fats = parseFloat(document.getElementById('fats').value);
            
            // Use custom calories if provided, otherwise auto-calculate
            const caloriesInput = document.getElementById('calories').value;
            const calories = caloriesInput ? parseFloat(caloriesInput) : (protein * 4 + carbs * 4 + fats * 9);
            
            const foodData = {
                name: document.getElementById('foodName').value,
                servingAmount: servingAmount,
                servingUnit: servingUnit,
                protein: protein,
                carbs: carbs,
                fats: fats,
                fiber: fiberValue,
                calories: calories,
                customCalories: !!caloriesInput // Track if user provided custom value
            };

            if (editingId) {
                // Update existing food
                const foodIndex = foodDatabase.findIndex(f => f.id === parseInt(editingId));
                if (foodIndex !== -1) {
                    foodDatabase[foodIndex] = {
                        ...foodDatabase[foodIndex],
                        ...foodData
                    };
                }
                document.getElementById('submitFoodBtn').textContent = 'Add to Database';
                document.getElementById('cancelEditBtn').style.display = 'none';
                document.getElementById('editingFoodId').value = '';
            } else {
                // Add new food
                const food = {
                    id: Date.now(),
                    ...foodData
                };
                foodDatabase.push(food);
            }

            localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
            
            renderFoodList();
            updateFoodSelectors();
            syncToFirebase(); // Sync to cloud
            e.target.reset();
        }

        function editFood(id) {
            const food = foodDatabase.find(f => f.id === id);
            if (!food) return;

            document.getElementById('editingFoodId').value = food.id;
            document.getElementById('foodName').value = food.name;
            document.getElementById('servingAmount').value = food.servingAmount;
            document.getElementById('servingUnit').value = food.servingUnit;
            document.getElementById('protein').value = food.protein;
            document.getElementById('carbs').value = food.carbs;
            document.getElementById('fats').value = food.fats;
            document.getElementById('fiber').value = food.fiber;
            
            // Only populate calories if it was custom (not auto-calculated)
            if (food.customCalories) {
                document.getElementById('calories').value = food.calories;
            } else {
                document.getElementById('calories').value = '';
            }
            
            document.getElementById('submitFoodBtn').textContent = 'Update Food';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // Scroll to form
            document.getElementById('addFoodForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('addFoodForm').reset();
            document.getElementById('editingFoodId').value = '';
            document.getElementById('submitFoodBtn').textContent = 'Add to Database';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function deleteFood(id) {
            if (confirm('Are you sure you want to delete this food?')) {
                foodDatabase = foodDatabase.filter(f => f.id !== id);
                localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                renderFoodList();
                updateFoodSelectors();
                syncToFirebase(); // Sync to cloud
            }
        }

        function renderFoodList() {
            const listDiv = document.getElementById('foodList');
            
            if (foodDatabase.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No foods added yet</div>';
                return;
            }

            // Sort alphabetically by name
            const sortedFoods = [...foodDatabase].sort((a, b) => a.name.localeCompare(b.name));

            // Create table
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th style="text-align:left;">Food</th>
                            <th>Serving</th>
                            <th>P</th><th>C</th><th>F</th><th>Fiber</th><th>Cal</th><th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedFoods.forEach((food, index) => {
                const calories = food.calories !== undefined ? food.calories : (food.protein * 4 + food.carbs * 4 + food.fats * 9);
                const servingLabel = `${food.servingAmount} ${UNIT_LABELS[food.servingUnit]}`;

                tableHTML += `
                    <tr class="food-row" data-name="${food.name.toLowerCase()}">
                        <td style="font-weight:600;">${food.name}</td>
                        <td style="text-align:center; color:var(--text-muted);">${servingLabel}</td>
                        <td class="protein-col">${food.protein}g</td>
                        <td class="carbs-col">${food.carbs}g</td>
                        <td class="fats-col">${food.fats}g</td>
                        <td style="text-align:center; color:var(--text-muted);">${food.fiber}g</td>
                        <td class="cal-col">${calories.toFixed(0)}</td>
                        <td style="text-align:center;">
                            <button class="btn-success btn-sm" onclick="editFood(${food.id})" style="margin-right:2px;">Edit</button>
                            <button class="btn-danger btn-sm" onclick="deleteFood(${food.id})">Del</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            listDiv.innerHTML = tableHTML;
        }

        function filterFoodList() {
            const searchInput = document.getElementById('foodSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.food-row');
            
            rows.forEach(row => {
                const foodName = row.getAttribute('data-name');
                if (foodName.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function updateFoodSelectors() {
            // This function is legacy - we now use custom autocomplete dropdowns
            // Keep it as a no-op for compatibility
            return;
        }

        // Create Meal - Food Autocomplete (handled below in autocomplete system section)

        function selectMealFood(foodName) {
            const food = foodDatabase.find(f => f.name === foodName);
            if (!food) return;
            
            document.getElementById('searchFoodForMeal').value = food.name;
            document.getElementById('selectedFoodForMeal').value = food.name;
            document.getElementById('mealFoodDropdown').style.display = 'none';
        }

        function filterMealFoodDropdown() {
            // Legacy function - redirect to new one
            filterMealFoodDropdownCustom();
        }

        function addFoodToMealBuilder() {
            // Get food name from either the hidden field (clicked) or the search box (typed)
            let foodName = document.getElementById('selectedFoodForMeal').value;
            if (!foodName) {
                foodName = document.getElementById('searchFoodForMeal').value.trim();
            }
            
            if (!foodName) {
                alert('Please select or type a food name');
                return;
            }

            // Find food (case-insensitive match)
            const food = foodDatabase.find(f => f.name.toLowerCase() === foodName.toLowerCase());
            
            if (!food) {
                alert(`Food "${foodName}" not found in database. Please select from the dropdown.`);
                return;
            }

            currentMealBuilder.push({
                ...food,
                builderId: Date.now(),
                amount: food.servingAmount,
                unit: food.servingUnit
            });

            renderMealBuilder();
            calculateMealTotals();
            
            // Reset the search
            document.getElementById('searchFoodForMeal').value = '';
            document.getElementById('selectedFoodForMeal').value = '';
            document.getElementById('mealFoodDropdown').style.display = 'none';
        }

        function removeFoodFromBuilder(builderId) {
            currentMealBuilder = currentMealBuilder.filter(f => f.builderId !== builderId);
            renderMealBuilder();
            calculateMealTotals();
        }

        function updateBuilderItem(builderId, field, value) {
            const item = currentMealBuilder.find(f => f.builderId === builderId);
            if (item) {
                item[field] = field === 'unit' ? value : parseFloat(value);
                renderMealBuilder();
                calculateMealTotals();
            }
        }

        function renderMealBuilder() {
            const tableBody = document.getElementById('mealBuilderTableBody');
            
            if (currentMealBuilder.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="empty-state" style="padding: 40px;">No foods in meal yet</td></tr>';
                return;
            }

            tableBody.innerHTML = currentMealBuilder.map((item, index) => {
                // Convert current amount to base units
                const baseUnits = convertToBaseUnit(item.amount, item.unit);
                // Get the food's base units
                const foodBaseUnits = convertToBaseUnit(item.servingAmount, item.servingUnit);
                // Calculate multiplier
                const multiplier = baseUnits / foodBaseUnits;
                
                const protein = (item.protein * multiplier).toFixed(1);
                const carbs = (item.carbs * multiplier).toFixed(1);
                const fats = (item.fats * multiplier).toFixed(1);
                const fiber = ((item.fiber || 0) * multiplier).toFixed(1);
                
                // Use stored calories if available, otherwise calculate
                const baseCalories = item.calories !== undefined ? item.calories : (item.protein * 4 + item.carbs * 4 + item.fats * 9);
                const calories = (baseCalories * multiplier).toFixed(0);
                
                // Calculate P/Cal ratio: (protein * 10) / calories
                const pCalRatio = calories > 0 ? ((parseFloat(protein) * 10) / parseFloat(calories)).toFixed(1) : 0;

                const rowBg = 'transparent';

                return `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid var(--border);">
                        <td style="padding: 10px; font-weight: 600; color: var(--text-primary);">${item.name}</td>
                        <td style="padding: 10px; text-align: center;">
                            <input type="number" value="${item.amount}" step="0.1" min="0.1" 
                                style="width: 80px; padding: 6px; border: 2px solid #e0e0e0; border-radius: 6px; text-align: center;"
                                onchange="updateBuilderItem(${item.builderId}, 'amount', this.value)">
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <select onchange="updateBuilderItem(${item.builderId}, 'unit', this.value)"
                                style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                <option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option>
                                <option value="oz" ${item.unit === 'oz' ? 'selected' : ''}>oz</option>
                                <option value="lb" ${item.unit === 'lb' ? 'selected' : ''}>lb</option>
                                <option value="cup" ${item.unit === 'cup' ? 'selected' : ''}>cup</option>
                                <option value="tbsp" ${item.unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                                <option value="tsp" ${item.unit === 'tsp' ? 'selected' : ''}>tsp</option>
                                <option value="ml" ${item.unit === 'ml' ? 'selected' : ''}>ml</option>
                                <option value="fl_oz" ${item.unit === 'fl_oz' ? 'selected' : ''}>fl oz</option>
                                <option value="piece" ${item.unit === 'piece' ? 'selected' : ''}>piece</option>
                                <option value="serving" ${item.unit === 'serving' ? 'selected' : ''}>serving</option>
                            </select>
                        </td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: var(--protein);">${protein}g</td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: var(--carbs);">${carbs}g</td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: var(--accent-green);">${fats}g</td>
                        <td style="padding: 10px; text-align: center; color: var(--text-muted);">${fiber}g</td>
                        <td style="padding: 10px; text-align: center; font-weight: 700;">${calories}</td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #475569;">${pCalRatio}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button onclick="removeFoodFromBuilder(${item.builderId})" 
                                style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateMealTotals() {
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFats = 0;
            let totalFiber = 0;
            let totalCalories = 0;

            currentMealBuilder.forEach(item => {
                const baseUnits = convertToBaseUnit(item.amount, item.unit);
                const foodBaseUnits = convertToBaseUnit(item.servingAmount, item.servingUnit);
                const multiplier = baseUnits / foodBaseUnits;
                
                totalProtein += item.protein * multiplier;
                totalCarbs += item.carbs * multiplier;
                totalFats += item.fats * multiplier;
                totalFiber += (item.fiber || 0) * multiplier;
                
                const itemCalories = item.calories !== undefined ? item.calories : (item.protein * 4 + item.carbs * 4 + item.fats * 9);
                totalCalories += itemCalories * multiplier;
            });

            const totalServings = parseFloat(document.getElementById('totalServings').value) || 1;
            
            const perServingProtein = totalProtein / totalServings;
            const perServingCarbs = totalCarbs / totalServings;
            const perServingFats = totalFats / totalServings;
            const perServingFiber = totalFiber / totalServings;
            const perServingCalories = totalCalories / totalServings;

            // Calculate P/Cal ratios
            const totalPCal = totalCalories > 0 ? ((totalProtein * 10) / totalCalories).toFixed(1) : 0;
            const perServingPCal = perServingCalories > 0 ? ((perServingProtein * 10) / perServingCalories).toFixed(1) : 0;

            // Update table totals
            document.getElementById('totalProteinTable').textContent = totalProtein.toFixed(1) + 'g';
            document.getElementById('totalCarbsTable').textContent = totalCarbs.toFixed(1) + 'g';
            document.getElementById('totalFatsTable').textContent = totalFats.toFixed(1) + 'g';
            document.getElementById('totalFiberTable').textContent = totalFiber.toFixed(1) + 'g';
            document.getElementById('totalCaloriesTable').textContent = totalCalories.toFixed(0);
            document.getElementById('totalPCalTable').textContent = totalPCal;

            document.getElementById('perServingProteinTable').textContent = perServingProtein.toFixed(1) + 'g';
            document.getElementById('perServingCarbsTable').textContent = perServingCarbs.toFixed(1) + 'g';
            document.getElementById('perServingFatsTable').textContent = perServingFats.toFixed(1) + 'g';
            document.getElementById('perServingFiberTable').textContent = perServingFiber.toFixed(1) + 'g';
            document.getElementById('perServingCaloriesTable').textContent = perServingCalories.toFixed(0);
            document.getElementById('perServingPCalTable').textContent = perServingPCal;
        }

        function saveMeal() {
            const mealName = document.getElementById('mealName').value.trim();
            if (!mealName || currentMealBuilder.length === 0) {
                return; // Silent fail if validation fails
            }

            const totalServings = parseFloat(document.getElementById('totalServings').value) || 1;
            const editingId = document.getElementById('editingMealId').value;

            // Calculate totals
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFats = 0;
            let totalFiber = 0;
            let totalCalories = 0;

            currentMealBuilder.forEach(item => {
                const baseUnits = convertToBaseUnit(item.amount, item.unit);
                const foodBaseUnits = convertToBaseUnit(item.servingAmount, item.servingUnit);
                const multiplier = baseUnits / foodBaseUnits;
                
                totalProtein += item.protein * multiplier;
                totalCarbs += item.carbs * multiplier;
                totalFats += item.fats * multiplier;
                totalFiber += (item.fiber || 0) * multiplier;
                
                const itemCalories = item.calories !== undefined ? item.calories : (item.protein * 4 + item.carbs * 4 + item.fats * 9);
                totalCalories += itemCalories * multiplier;
            });

            const mealData = {
                name: mealName,
                totalServings: totalServings,
                foods: currentMealBuilder,
                perServing: {
                    protein: totalProtein / totalServings,
                    carbs: totalCarbs / totalServings,
                    fats: totalFats / totalServings,
                    fiber: totalFiber / totalServings,
                    calories: totalCalories / totalServings
                }
            };

            if (editingId) {
                // Update existing meal
                const mealIndex = savedMeals.findIndex(m => m.id === parseInt(editingId));
                if (mealIndex !== -1) {
                    savedMeals[mealIndex] = {
                        ...savedMeals[mealIndex],
                        ...mealData
                    };
                }
            } else {
                // Create new meal
                const meal = {
                    id: Date.now(),
                    ...mealData
                };
                savedMeals.push(meal);
            }

            localStorage.setItem('savedMeals', JSON.stringify(savedMeals));

            // Clear builder
            cancelMealEdit();
            renderSavedMeals();
            updateMealSelector();
            syncToFirebase(); // Sync to cloud
        }

        function deleteMeal(id) {
            if (confirm('Are you sure you want to delete this meal?')) {
                savedMeals = savedMeals.filter(m => m.id !== id);
                localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
                renderSavedMeals();
                updateMealSelector();
                syncToFirebase(); // Sync to cloud
            }
        }

        function renderSavedMeals() {
            const listDiv = document.getElementById('savedMealsList');
            
            if (savedMeals.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No saved meals yet</div>';
                return;
            }

            // Sort alphabetically by name
            const sortedMeals = [...savedMeals].sort((a, b) => a.name.localeCompare(b.name));

            // Create table
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th style="text-align:left;">Meal</th><th>Srv</th><th>P/srv</th><th>C/srv</th><th>F/srv</th><th>Fib</th><th>Cal/srv</th><th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedMeals.forEach((meal, index) => {
                const calories = meal.perServing.calories || (meal.perServing.protein * 4 + meal.perServing.carbs * 4 + meal.perServing.fats * 9);

                tableHTML += `
                    <tr>
                        <td style="font-weight:600;">${meal.name}</td>
                        <td style="text-align:center; color:var(--text-muted);">${meal.totalServings}</td>
                        <td class="protein-col">${meal.perServing.protein.toFixed(1)}g</td>
                        <td class="carbs-col">${meal.perServing.carbs.toFixed(1)}g</td>
                        <td class="fats-col">${meal.perServing.fats.toFixed(1)}g</td>
                        <td style="text-align:center; color:var(--text-muted);">${meal.perServing.fiber.toFixed(1)}g</td>
                        <td class="cal-col">${calories.toFixed(0)}</td>
                        <td style="text-align:center;">
                            <button class="btn-success btn-sm" onclick="editMeal(${meal.id})" style="margin-right:2px;">Edit</button>
                            <button class="btn-danger btn-sm" onclick="deleteMeal(${meal.id})">Del</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            listDiv.innerHTML = tableHTML;
        }

        function updateMealSelector() {
            // Using custom autocomplete now - this function is kept as no-op for compatibility
            return;
        }

        // ========== NEW CUSTOM AUTOCOMPLETE SYSTEM ==========
        
        // Create Meal - Food Autocomplete
        function handleMealFoodKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addFoodToMealBuilder();
            }
        }

        function showMealFoodDropdown() {
            filterMealFoodDropdownCustom();
        }

        function filterMealFoodDropdownCustom() {
            const searchInput = document.getElementById('searchFoodForMeal');
            const dropdown = document.getElementById('mealFoodDropdown');
            
            if (!searchInput || !dropdown) return;
            
            const searchValue = searchInput.value.toLowerCase().trim();
            
            // Filter foods
            let matchingFoods = foodDatabase;
            if (searchValue) {
                matchingFoods = foodDatabase.filter(food => 
                    food.name.toLowerCase().includes(searchValue)
                );
            }
            
            // Sort by relevance (starts with search term first, then alphabetically)
            matchingFoods.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                const aStarts = aName.startsWith(searchValue);
                const bStarts = bName.startsWith(searchValue);
                
                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                return aName.localeCompare(bName);
            });
            
            // Limit to top 20 results for performance
            matchingFoods = matchingFoods.slice(0, 20);
            
            if (matchingFoods.length === 0) {
                dropdown.innerHTML = '<div class="empty-state" style="padding:12px;">No foods found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            // Render dropdown
            dropdown.innerHTML = matchingFoods.map(food => {
                const calories = food.calories || (food.protein * 4 + food.carbs * 4 + food.fats * 9);
                return `
                    <div onclick="selectMealFood('${food.name.replace(/'/g, "\\'")}')" 
                        class="dropdown-item"
                        onmouseover="this.style.background='rgba(56,189,248,0.08)'" 
                        onmouseout="this.style.background='transparent'">
                        <div class="dropdown-item-name">${food.name}</div>
                        <div class="dropdown-item-meta">
                            ${food.servingAmount} ${UNIT_LABELS[food.servingUnit]} ‚Ä¢ 
                            P: ${food.protein}g C: ${food.carbs}g F: ${food.fats}g ‚Ä¢ 
                            ${calories.toFixed(0)} cal
                        </div>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }

        function selectMealFood(foodName) {
            const food = foodDatabase.find(f => f.name === foodName);
            if (!food) return;
            
            document.getElementById('searchFoodForMeal').value = food.name;
            document.getElementById('selectedFoodForMeal').value = food.name;
            document.getElementById('mealFoodDropdown').style.display = 'none';
        }

        function filterMealFoodDropdown() {
            // Legacy function - redirect to new one
            filterMealFoodDropdownCustom();
        }

        // My Day - Meal Autocomplete
        function showDayMealDropdown() {
            filterDayMealDropdownCustom();
        }

        function filterDayMealDropdownCustom() {
            const searchInput = document.getElementById('searchMealForDay');
            const dropdown = document.getElementById('dayMealDropdown');
            
            if (!searchInput || !dropdown) return;
            
            const searchValue = searchInput.value.toLowerCase().trim();
            
            // Filter meals
            let matchingMeals = savedMeals;
            if (searchValue) {
                matchingMeals = savedMeals.filter(meal => 
                    meal.name.toLowerCase().includes(searchValue)
                );
            }
            
            // Sort by relevance
            matchingMeals.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                const aStarts = aName.startsWith(searchValue);
                const bStarts = bName.startsWith(searchValue);
                
                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                return aName.localeCompare(bName);
            });
            
            // Limit to top 20 results
            matchingMeals = matchingMeals.slice(0, 20);
            
            if (matchingMeals.length === 0) {
                dropdown.innerHTML = '<div class="empty-state" style="padding:12px;">No meals found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            // Render dropdown
            dropdown.innerHTML = matchingMeals.map(meal => {
                const calories = meal.perServing.calories || (meal.perServing.protein * 4 + meal.perServing.carbs * 4 + meal.perServing.fats * 9);
                return `
                    <div onclick="selectDayMeal('${meal.name.replace(/'/g, "\\'")}')" 
                        class="dropdown-item"
                        onmouseover="this.style.background='rgba(56,189,248,0.08)'" 
                        onmouseout="this.style.background='transparent'">
                        <div class="dropdown-item-name" style="color:var(--accent-blue);">${meal.name}</div>
                        <div class="dropdown-item-meta">
                            ${meal.totalServings} servings ‚Ä¢ 
                            P: ${meal.perServing.protein.toFixed(1)}g 
                            C: ${meal.perServing.carbs.toFixed(1)}g 
                            F: ${meal.perServing.fats.toFixed(1)}g ‚Ä¢ 
                            ${calories.toFixed(0)} cal/srv
                        </div>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }

        function selectDayMeal(mealName) {
            const meal = savedMeals.find(m => m.name === mealName);
            if (!meal) return;
            
            document.getElementById('searchMealForDay').value = meal.name;
            document.getElementById('selectedMealForDay').value = meal.name;
            document.getElementById('dayMealDropdown').style.display = 'none';
        }

        function filterDayMealDropdown() {
            // Legacy function - redirect to new one
            filterDayMealDropdownCustom();
        }

        // My Day - Food Autocomplete
        function showDayFoodDropdown() {
            filterDayFoodDropdownCustom();
        }

        function filterDayFoodDropdownCustom() {
            const searchInput = document.getElementById('searchFoodForDay');
            const dropdown = document.getElementById('dayFoodDropdown');
            
            if (!searchInput || !dropdown) return;
            
            const searchValue = searchInput.value.toLowerCase().trim();
            
            // Filter foods
            let matchingFoods = foodDatabase;
            if (searchValue) {
                matchingFoods = foodDatabase.filter(food => 
                    food.name.toLowerCase().includes(searchValue)
                );
            }
            
            // Sort by relevance
            matchingFoods.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                const aStarts = aName.startsWith(searchValue);
                const bStarts = bName.startsWith(searchValue);
                
                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                return aName.localeCompare(bName);
            });
            
            // Limit to top 20 results
            matchingFoods = matchingFoods.slice(0, 20);
            
            if (matchingFoods.length === 0) {
                dropdown.innerHTML = '<div class="empty-state" style="padding:12px;">No foods found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            // Render dropdown
            dropdown.innerHTML = matchingFoods.map(food => {
                const calories = food.calories || (food.protein * 4 + food.carbs * 4 + food.fats * 9);
                return `
                    <div onclick="selectDayFood('${food.name.replace(/'/g, "\\'")}')" 
                        class="dropdown-item"
                        onmouseover="this.style.background='#e8f8f3'" 
                        onmouseout="this.style.background='transparent'">
                        <div style="font-weight: 600; color: #065f46; margin-bottom: 2px;">${food.name}</div>
                        <div class="dropdown-item-meta">
                            ${food.servingAmount} ${UNIT_LABELS[food.servingUnit]} ‚Ä¢ 
                            P: ${food.protein}g C: ${food.carbs}g F: ${food.fats}g ‚Ä¢ 
                            ${calories.toFixed(0)} cal
                        </div>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }

        function selectDayFood(foodName) {
            const food = foodDatabase.find(f => f.name === foodName);
            if (!food) return;
            
            document.getElementById('searchFoodForDay').value = food.name;
            document.getElementById('selectedFoodForDay').value = food.name;
            document.getElementById('dayFoodDropdown').style.display = 'none';
        }

        function filterDayFoodDropdown() {
            // Legacy function - redirect to new one
            filterDayFoodDropdownCustom();
        }

        // ========== END NEW CUSTOM AUTOCOMPLETE SYSTEM ==========

        // Dynamic meal search with autocomplete dropdown (OLD - keeping for compatibility)
        let selectedMealForDay = null;

        function showMealDropdown() {
            filterDayMealDropdownDynamic();
        }

        function filterDayMealDropdownDynamic() {
            const searchText = document.getElementById('searchMealForDay').value.toLowerCase().trim();
            const dropdown = document.getElementById('mealDropdownResults');
            
            if (searchText === '') {
                // Show all meals when empty
                const allMeals = savedMeals.slice(0, 10); // Limit to 10 for performance
                renderMealDropdown(allMeals);
                dropdown.style.display = 'block';
                return;
            }
            
            // Filter meals
            const filtered = savedMeals.filter(meal => 
                meal.name.toLowerCase().includes(searchText)
            ).slice(0, 10);
            
            renderMealDropdown(filtered);
            dropdown.style.display = filtered.length > 0 ? 'block' : 'none';
        }

        function renderMealDropdown(meals) {
            const dropdown = document.getElementById('mealDropdownResults');
            
            if (meals.length === 0) {
                dropdown.innerHTML = '<div class="empty-state" style="padding:12px;">No meals found</div>';
                return;
            }
            
            dropdown.innerHTML = meals.map(meal => {
                const calories = meal.macros.calories || (meal.macros.protein * 4 + meal.macros.carbs * 4 + meal.macros.fats * 9);
                return `
                    <div onclick="selectMealForDay('${meal.name}')" 
                        style="padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;"
                        onmouseover="this.style.background='#e8f4fd'" 
                        onmouseout="this.style.background='transparent'">
                        <div style="font-weight: 600; color: #2c5282; margin-bottom: 4px;">${meal.name}</div>
                        <div class="dropdown-item-meta">
                            P: ${meal.macros.protein.toFixed(1)}g | 
                            C: ${meal.macros.carbs.toFixed(1)}g | 
                            F: ${meal.macros.fats.toFixed(1)}g | 
                            ${calories.toFixed(0)} cal
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectMealForDay(mealName) {
            const meal = savedMeals.find(m => m.name === mealName);
            if (!meal) return;
            
            selectedMealForDay = meal;
            
            // Update search box
            document.getElementById('searchMealForDay').value = meal.name;
            
            // Hide dropdown
            document.getElementById('mealDropdownResults').style.display = 'none';
            
            // Show selected display
            const calories = meal.macros.calories || (meal.macros.protein * 4 + meal.macros.carbs * 4 + meal.macros.fats * 9);
            document.getElementById('selectedMealName').textContent = meal.name;
            document.getElementById('selectedMealMacros').textContent = 
                `P: ${meal.macros.protein.toFixed(1)}g | C: ${meal.macros.carbs.toFixed(1)}g | F: ${meal.macros.fats.toFixed(1)}g | ${calories.toFixed(0)} cal`;
            document.getElementById('selectedMealDisplay').style.display = 'block';
        }

        function clearMealSelection() {
            selectedMealForDay = null;
            document.getElementById('searchMealForDay').value = '';
            document.getElementById('selectedMealDisplay').style.display = 'none';
            document.getElementById('mealDropdownResults').style.display = 'none';
        }

        // Dynamic food search with autocomplete dropdown
        let selectedFoodForDay = null;

        function showFoodDropdown() {
            filterDayFoodDropdownDynamic();
        }

        function filterDayFoodDropdownDynamic() {
            const searchText = document.getElementById('searchFoodForDay').value.toLowerCase().trim();
            const dropdown = document.getElementById('foodDropdownResults');
            
            if (searchText === '') {
                // Show all foods when empty
                const allFoods = foodDatabase.slice(0, 10); // Limit to 10 for performance
                renderFoodDropdown(allFoods);
                dropdown.style.display = 'block';
                return;
            }
            
            // Filter foods
            const filtered = foodDatabase.filter(food => 
                food.name.toLowerCase().includes(searchText)
            ).slice(0, 10);
            
            renderFoodDropdown(filtered);
            dropdown.style.display = filtered.length > 0 ? 'block' : 'none';
        }

        function renderFoodDropdown(foods) {
            const dropdown = document.getElementById('foodDropdownResults');
            
            if (foods.length === 0) {
                dropdown.innerHTML = '<div class="empty-state" style="padding:12px;">No foods found</div>';
                return;
            }
            
            dropdown.innerHTML = foods.map(food => {
                const calories = food.macros.calories || (food.macros.protein * 4 + food.macros.carbs * 4 + food.macros.fats * 9);
                return `
                    <div onclick="selectFoodForDay('${food.name}')" 
                        style="padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;"
                        onmouseover="this.style.background='#e8f8f3'" 
                        onmouseout="this.style.background='transparent'">
                        <div style="font-weight: 600; color: #065f46; margin-bottom: 4px;">${food.name}</div>
                        <div class="dropdown-item-meta">
                            P: ${food.macros.protein.toFixed(1)}g | 
                            C: ${food.macros.carbs.toFixed(1)}g | 
                            F: ${food.macros.fats.toFixed(1)}g | 
                            ${calories.toFixed(0)} cal
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectFoodForDay(foodName) {
            const food = foodDatabase.find(f => f.name === foodName);
            if (!food) return;
            
            selectedFoodForDay = food;
            
            // Update search box
            document.getElementById('searchFoodForDay').value = food.name;
            
            // Hide dropdown
            document.getElementById('foodDropdownResults').style.display = 'none';
            
            // Show selected display
            const calories = food.macros.calories || (food.macros.protein * 4 + food.macros.carbs * 4 + food.macros.fats * 9);
            document.getElementById('selectedFoodName').textContent = food.name;
            document.getElementById('selectedFoodMacros').textContent = 
                `P: ${food.macros.protein.toFixed(1)}g | C: ${food.macros.carbs.toFixed(1)}g | F: ${food.macros.fats.toFixed(1)}g | ${calories.toFixed(0)} cal`;
            document.getElementById('selectedFoodDisplay').style.display = 'block';
        }

        function clearFoodSelection() {
            selectedFoodForDay = null;
            document.getElementById('searchFoodForDay').value = '';
            document.getElementById('selectedFoodDisplay').style.display = 'none';
            document.getElementById('foodDropdownResults').style.display = 'none';
        }

        // Old filter functions (kept for compatibility)
        function filterDayMealDropdown() {
            const searchInput = document.getElementById('searchMealForDay');
            const select = document.getElementById('selectMealForDay');
            if (!searchInput || !select) return;
            
            const searchValue = searchInput.value.toLowerCase();
            const options = select.querySelectorAll('option');
            
            let visibleCount = 0;
            let firstVisible = null;
            
            options.forEach(option => {
                const mealName = option.value.toLowerCase();
                const shouldShow = mealName === '' || mealName.includes(searchValue);
                
                option.style.display = shouldShow ? '' : 'none';
                
                if (shouldShow && option.value !== '') {
                    visibleCount++;
                    if (!firstVisible) firstVisible = option;
                }
            });
            
            // Auto-select first visible option if only one match
            if (visibleCount === 1 && firstVisible) {
                select.value = firstVisible.value;
            } else if (visibleCount === 0) {
                select.value = '';
            }
        }

        function updateDayFoodSelector() {
            // Using custom autocomplete now - this function is kept as no-op for compatibility
            return;
        }

        function filterDayFoodDropdown() {
            const searchInput = document.getElementById('searchFoodForDay');
            const select = document.getElementById('selectFoodForDay');
            if (!searchInput || !select) return;
            
            const searchValue = searchInput.value.toLowerCase();
            const options = select.querySelectorAll('option');
            
            let visibleCount = 0;
            let firstVisible = null;
            
            options.forEach(option => {
                const foodName = option.value.toLowerCase();
                const shouldShow = foodName === '' || foodName.includes(searchValue);
                
                option.style.display = shouldShow ? '' : 'none';
                
                if (shouldShow && option.value !== '') {
                    visibleCount++;
                    if (!firstVisible) firstVisible = option;
                }
            });
            
            // Auto-select first visible option if only one match
            if (visibleCount === 1 && firstVisible) {
                select.value = firstVisible.value;
            } else if (visibleCount === 0) {
                select.value = '';
            }
        }

        // ===== UNIFIED SEARCH (Meals + Foods) =====
        function filterUnifiedDropdown() {
            const searchInput = document.getElementById('searchItemForDay');
            const dropdown = document.getElementById('dayUnifiedDropdown');
            if (!searchInput || !dropdown) return;

            const query = searchInput.value.toLowerCase().trim();
            const showMeals = document.getElementById('filterMeals').checked;
            const showFoods = document.getElementById('filterFoods').checked;

            // Clear selection when typing
            document.getElementById('selectedItemName').value = '';
            document.getElementById('selectedItemType').value = '';

            let results = [];

            // Search meals
            if (showMeals) {
                let meals = savedMeals;
                if (query) meals = meals.filter(m => m.name.toLowerCase().includes(query));
                meals.sort((a, b) => {
                    const aS = a.name.toLowerCase().startsWith(query);
                    const bS = b.name.toLowerCase().startsWith(query);
                    if (aS && !bS) return -1;
                    if (!aS && bS) return 1;
                    return a.name.localeCompare(b.name);
                });
                meals.slice(0, 12).forEach(meal => {
                    const cal = meal.perServing.calories || (meal.perServing.protein * 4 + meal.perServing.carbs * 4 + meal.perServing.fats * 9);
                    results.push({
                        type: 'meal',
                        name: meal.name,
                        html: `<div class="dropdown-item-name" style="color:var(--accent);">${meal.name}</div>
                               <div class="dropdown-item-meta">üçΩ Meal ¬∑ ${meal.totalServings} srv ¬∑ P:${meal.perServing.protein.toFixed(0)}g C:${meal.perServing.carbs.toFixed(0)}g F:${meal.perServing.fats.toFixed(0)}g ¬∑ ${cal.toFixed(0)} cal</div>`
                    });
                });
            }

            // Search foods
            if (showFoods) {
                let foods = foodDatabase;
                if (query) foods = foods.filter(f => f.name.toLowerCase().includes(query));
                foods.sort((a, b) => {
                    const aS = a.name.toLowerCase().startsWith(query);
                    const bS = b.name.toLowerCase().startsWith(query);
                    if (aS && !bS) return -1;
                    if (!aS && bS) return 1;
                    return a.name.localeCompare(b.name);
                });
                foods.slice(0, 12).forEach(food => {
                    const cal = food.calories || (food.protein * 4 + food.carbs * 4 + food.fats * 9);
                    results.push({
                        type: 'food',
                        name: food.name,
                        html: `<div class="dropdown-item-name">${food.name}</div>
                               <div class="dropdown-item-meta">ü•Ñ Food ¬∑ ${food.servingAmount} ${UNIT_LABELS[food.servingUnit]} ¬∑ P:${food.protein}g C:${food.carbs}g F:${food.fats}g ¬∑ ${cal.toFixed(0)} cal</div>`
                    });
                });
            }

            // Interleave results: sort by relevance to query
            if (query) {
                results.sort((a, b) => {
                    const aS = a.name.toLowerCase().startsWith(query);
                    const bS = b.name.toLowerCase().startsWith(query);
                    if (aS && !bS) return -1;
                    if (!aS && bS) return 1;
                    return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                });
            }

            results = results.slice(0, 20);

            if (results.length === 0) {
                dropdown.innerHTML = '<div class="empty-state" style="padding:12px;">No results found</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = results.map(r => `
                <div onclick="selectUnifiedItem('${r.type}', '${r.name.replace(/'/g, "\\'")}')"
                     class="dropdown-item">
                    ${r.html}
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        function selectUnifiedItem(type, name) {
            document.getElementById('searchItemForDay').value = name;
            document.getElementById('selectedItemName').value = name;
            document.getElementById('selectedItemType').value = type;
            document.getElementById('dayUnifiedDropdown').style.display = 'none';
        }

        function addItemToDay() {
            const name = document.getElementById('selectedItemName').value || document.getElementById('searchItemForDay').value.trim();
            let type = document.getElementById('selectedItemType').value;

            if (!name) {
                alert('Please select a meal or food first');
                return;
            }

            // Auto-detect type if not set (user typed name without selecting from dropdown)
            if (!type) {
                if (savedMeals.find(m => m.name === name)) type = 'meal';
                else if (foodDatabase.find(f => f.name === name)) type = 'food';
                else {
                    alert('Item not found. Please select from the dropdown.');
                    return;
                }
            }

            const amount = parseFloat(document.getElementById('itemAmountForDay').value) || 1;
            const unit = document.getElementById('itemUnitForDay').value;

            if (type === 'meal') {
                const meal = savedMeals.find(m => m.name === name);
                if (!meal) { alert('Meal not found'); return; }

                todaysMeals.push({
                    id: Date.now(),
                    type: 'meal',
                    mealId: meal.id,
                    mealName: meal.name,
                    amount: amount,
                    unit: unit,
                    macros: meal.perServing
                });
            } else {
                const food = foodDatabase.find(f => f.name === name);
                if (!food) { alert('Food not found'); return; }

                const baseUnits = convertToBaseUnit(amount, unit);
                const foodBaseUnits = convertToBaseUnit(food.servingAmount, food.servingUnit);
                const multiplier = baseUnits / foodBaseUnits;

                todaysMeals.push({
                    id: Date.now(),
                    type: 'food',
                    foodName: food.name,
                    amount: amount,
                    unit: unit,
                    macros: {
                        protein: food.protein * multiplier,
                        carbs: food.carbs * multiplier,
                        fats: food.fats * multiplier,
                        fiber: (food.fiber || 0) * multiplier,
                        calories: (food.calories !== undefined ? food.calories : (food.protein * 4 + food.carbs * 4 + food.fats * 9)) * multiplier
                    }
                });
            }

            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
            renderDayMeals();
            calculateDayTotals();
            syncToFirebase();

            // Reset
            document.getElementById('searchItemForDay').value = '';
            document.getElementById('selectedItemName').value = '';
            document.getElementById('selectedItemType').value = '';
            document.getElementById('itemAmountForDay').value = '1';
            document.getElementById('dayUnifiedDropdown').style.display = 'none';
        }

        function setDayAddType(type) {
            // Legacy function ‚Äî kept for compatibility
        }

        function editMeal(id) {
            const meal = savedMeals.find(m => m.id === id);
            if (!meal) return;

            // Switch to meals page
            showPage('meals');

            // Populate the form
            document.getElementById('editingMealId').value = meal.id;
            document.getElementById('mealName').value = meal.name;
            document.getElementById('totalServings').value = meal.totalServings;
            
            // Load the foods into the builder
            currentMealBuilder = meal.foods.map(food => ({
                ...food,
                builderId: Date.now() + Math.random() // New unique IDs for editing
            }));

            // Update UI
            document.getElementById('mealBuilderTitle').textContent = 'Edit Meal';
            document.getElementById('saveMealBtn').textContent = 'Update Meal';
            document.getElementById('cancelMealEditBtn').style.display = 'block';
            
            renderMealBuilder();
            calculateMealTotals();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelMealEdit() {
            document.getElementById('editingMealId').value = '';
            document.getElementById('mealName').value = '';
            document.getElementById('totalServings').value = '1';
            currentMealBuilder = [];
            
            document.getElementById('mealBuilderTitle').textContent = 'Build Your Meal';
            document.getElementById('saveMealBtn').textContent = 'Save Meal';
            document.getElementById('cancelMealEditBtn').style.display = 'none';
            
            renderMealBuilder();
            calculateMealTotals();
        }

        function addFoodToDay() {
            const foodName = document.getElementById('selectedFoodForDay').value || document.getElementById('searchFoodForDay').value.trim();
            if (!foodName) {
                alert('Please select a food first');
                return;
            }

            const food = foodDatabase.find(f => f.name === foodName);
            if (!food) return;

            const amount = parseFloat(document.getElementById('foodAmountForDay').value) || 1;
            const unit = document.getElementById('foodUnitForDay').value;

            // Convert to multiplier for macros
            const baseUnits = convertToBaseUnit(amount, unit);
            const foodBaseUnits = convertToBaseUnit(food.servingAmount, food.servingUnit);
            const multiplier = baseUnits / foodBaseUnits;

            todaysMeals.push({
                id: Date.now(),
                type: 'food',
                foodName: food.name,
                amount: amount,
                unit: unit,
                macros: {
                    protein: food.protein * multiplier,
                    carbs: food.carbs * multiplier,
                    fats: food.fats * multiplier,
                    fiber: (food.fiber || 0) * multiplier,
                    calories: (food.calories !== undefined ? food.calories : (food.protein * 4 + food.carbs * 4 + food.fats * 9)) * multiplier
                }
            });

            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
            renderDayMeals();
            calculateDayTotals();
            syncToFirebase();
            
            // Reset inputs
            document.getElementById('searchFoodForDay').value = '';
            document.getElementById('selectedFoodForDay').value = '';
            document.getElementById('foodAmountForDay').value = '1';
            document.getElementById('dayFoodDropdown').style.display = 'none';
        }

        function addMealToDay() {
            const mealName = document.getElementById('selectedMealForDay').value || document.getElementById('searchMealForDay').value.trim();
            if (!mealName) {
                alert('Please select a meal first');
                return;
            }

            const meal = savedMeals.find(m => m.name === mealName);
            if (!meal) return;

            const amount = parseFloat(document.getElementById('mealServingsForDay').value) || 1;
            const unit = document.getElementById('mealUnitForDay').value;

            todaysMeals.push({
                id: Date.now(),
                type: 'meal',
                mealId: meal.id,
                mealName: meal.name,
                amount: amount,
                unit: unit,
                macros: meal.perServing
            });

            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
            renderDayMeals();
            calculateDayTotals();
            syncToFirebase();
            
            // Reset inputs
            document.getElementById('searchMealForDay').value = '';
            document.getElementById('selectedMealForDay').value = '';
            document.getElementById('mealServingsForDay').value = '1';
            document.getElementById('dayMealDropdown').style.display = 'none';
        }

        function removeMealFromDay(id) {
            todaysMeals = todaysMeals.filter(m => m.id !== id);
            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
            renderDayMeals();
            calculateDayTotals();
            syncToFirebase(); // Sync to cloud
        }

        function updateDayMealAmount(id, amount) {
            const meal = todaysMeals.find(m => m.id === id);
            if (meal) {
                meal.amount = parseFloat(amount);
                localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                renderDayMeals();
                calculateDayTotals();
                syncToFirebase(); // Sync to cloud
            }
        }

        function updateDayMealUnit(id, unit) {
            const meal = todaysMeals.find(m => m.id === id);
            if (meal) {
                meal.unit = unit;
                localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                renderDayMeals();
                calculateDayTotals();
                syncToFirebase(); // Sync to cloud
            }
        }

        function renderDayMeals() {
            const listDiv = document.getElementById('dayMealsList');
            
            if (todaysMeals.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No meals added today</div>';
                calculateDayTotals();
                return;
            }

            // Create table header
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: rgba(56,189,248,0.1);">
                            <th style="padding: 12px; text-align: left; border-radius: 8px 0 0 0;">Item</th>
                            <th style="padding: 12px; text-align: center;">Amount</th>
                            <th style="padding: 12px; text-align: center;">Protein</th>
                            <th style="padding: 12px; text-align: center;">Carbs</th>
                            <th style="padding: 12px; text-align: center;">Fats</th>
                            <th style="padding: 12px; text-align: center;">Fiber</th>
                            <th style="padding: 12px; text-align: center;">Calories</th>
                            <th style="padding: 12px; text-align: center; border-radius: 0 8px 0 0;"></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            todaysMeals.forEach((item, index) => {
                // Handle legacy data and determine type
                const itemType = item.type || 'meal';
                const displayName = item.mealName || item.foodName || 'Unknown Item';
                const amount = item.amount !== undefined ? item.amount : (item.servings || 1);
                const unit = item.unit || 'serving';
                
                // For meals, apply multiplier; for foods, macros already calculated
                const protein = itemType === 'meal' ? (item.macros.protein * amount).toFixed(1) : item.macros.protein.toFixed(1);
                const carbs = itemType === 'meal' ? (item.macros.carbs * amount).toFixed(1) : item.macros.carbs.toFixed(1);
                const fats = itemType === 'meal' ? (item.macros.fats * amount).toFixed(1) : item.macros.fats.toFixed(1);
                const fiber = itemType === 'meal' ? (item.macros.fiber * amount).toFixed(1) : item.macros.fiber.toFixed(1);
                
                // Calculate calories
                let calories;
                if (itemType === 'food') {
                    calories = item.macros.calories.toFixed(0);
                } else {
                    const calsFromMacros = (item.macros.protein * 4 + item.macros.carbs * 4 + item.macros.fats * 9) * amount;
                    calories = (item.macros.calories ? item.macros.calories * amount : calsFromMacros).toFixed(0);
                }

                // Type badge
                const typeBadge = itemType === 'food' 
                    ? '<span style="background: rgba(52,211,153,0.2); color: var(--accent-green); padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">FOOD</span>'
                    : '<span style="background: rgba(56,189,248,0.2); color: var(--accent-blue); padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">MEAL</span>';

                // Alternate row colors
                const rowBg = 'transparent';

                tableHTML += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px; font-weight: 600; color: var(--text-primary);">
                            ${displayName}${typeBadge}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: flex; gap: 4px; justify-content: center; align-items: center;">
                                <input type="number" value="${amount}" step="0.1" min="0.1" 
                                    style="width: 60px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; text-align: center;"
                                    onchange="updateDayMealAmount(${item.id}, this.value)" ${itemType === 'food' ? 'disabled' : ''}>
                                <select onchange="updateDayMealUnit(${item.id}, this.value)" 
                                    style="padding: 4px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem;"
                                    ${itemType === 'food' ? 'disabled' : ''}>
                                    <option value="serving" ${unit === 'serving' ? 'selected' : ''}>srv</option>
                                    <option value="g" ${unit === 'g' ? 'selected' : ''}>g</option>
                                    <option value="oz" ${unit === 'oz' ? 'selected' : ''}>oz</option>
                                    <option value="lb" ${unit === 'lb' ? 'selected' : ''}>lb</option>
                                    <option value="cup" ${unit === 'cup' ? 'selected' : ''}>cup</option>
                                    <option value="tbsp" ${unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                                    <option value="tsp" ${unit === 'tsp' ? 'selected' : ''}>tsp</option>
                                    <option value="piece" ${unit === 'piece' ? 'selected' : ''}>pc</option>
                                </select>
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--protein);">${protein}g</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--carbs);">${carbs}g</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--accent-green);">${fats}g</td>
                        <td style="padding: 12px; text-align: center; color: var(--text-muted);">${fiber}g</td>
                        <td style="padding: 12px; text-align: center; font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">${calories}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-danger" onclick="removeMealFromDay(${item.id})" 
                                style="padding: 6px 12px; font-size: 0.8rem;">‚úï</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            listDiv.innerHTML = tableHTML;
            calculateDayTotals();
        }

        function calculateDayTotals() {
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFats = 0;
            let totalFiber = 0;
            let totalCalories = 0;

            todaysMeals.forEach(item => {
                const itemType = item.type || 'meal';
                const amount = item.amount !== undefined ? item.amount : (item.servings || 1);
                
                if (itemType === 'food') {
                    // Foods already have calculated macros
                    totalProtein += item.macros.protein;
                    totalCarbs += item.macros.carbs;
                    totalFats += item.macros.fats;
                    totalFiber += item.macros.fiber;
                    totalCalories += item.macros.calories || (item.macros.protein * 4 + item.macros.carbs * 4 + item.macros.fats * 9);
                } else {
                    // Meals need to be multiplied by amount
                    totalProtein += item.macros.protein * amount;
                    totalCarbs += item.macros.carbs * amount;
                    totalFats += item.macros.fats * amount;
                    totalFiber += item.macros.fiber * amount;
                    totalCalories += (item.macros.calories || (item.macros.protein * 4 + item.macros.carbs * 4 + item.macros.fats * 9)) * amount;
                }
            });

            // Calculate percentages of calories from each macro
            const proteinPct = totalCalories > 0 ? ((totalProtein * 4 / totalCalories) * 100).toFixed(0) : 0;
            const carbsPct = totalCalories > 0 ? ((totalCarbs * 4 / totalCalories) * 100).toFixed(0) : 0;
            const fatsPct = totalCalories > 0 ? ((totalFats * 9 / totalCalories) * 100).toFixed(0) : 0;

            document.getElementById('dayProtein').textContent = Math.round(totalProtein);
            document.getElementById('dayCarbs').textContent = Math.round(totalCarbs);
            document.getElementById('dayFats').textContent = Math.round(totalFats);
            document.getElementById('dayCalories').textContent = Math.round(totalCalories);
            document.getElementById('dayFiber').textContent = totalFiber.toFixed(1);
            
            // Update remaining amounts if goals are set
            if (dailyGoals) {
                const remainingProtein = dailyGoals.protein - totalProtein;
                const remainingCalories = dailyGoals.calories - totalCalories;
                
                document.getElementById('remainingProtein').innerHTML = 
                    remainingProtein >= 0 
                    ? `<span class="remaining-good">${Math.round(remainingProtein)}</span>` 
                    : `<span class="remaining-over">${Math.round(Math.abs(remainingProtein))}</span>`;
                
                document.getElementById('remainingCalories').innerHTML = 
                    remainingCalories >= 0 
                    ? `<span class="remaining-good">${Math.round(remainingCalories)}</span>` 
                    : `<span class="remaining-over">${Math.round(Math.abs(remainingCalories))}</span>`;
                
                // Optional carbs goal
                if (dailyGoals.carbs !== null && dailyGoals.carbs !== undefined) {
                    const remainingCarbs = dailyGoals.carbs - totalCarbs;
                    document.getElementById('remainingCarbs').innerHTML = 
                        remainingCarbs >= 0 
                        ? `<span class="remaining-good">${Math.round(remainingCarbs)}</span>` 
                        : `<span class="remaining-over">${Math.round(Math.abs(remainingCarbs))}</span>`;
                } else {
                    document.getElementById('remainingCarbs').innerHTML = '';
                }
                
                // Optional fats goal
                if (dailyGoals.fats !== null && dailyGoals.fats !== undefined) {
                    const remainingFats = dailyGoals.fats - totalFats;
                    document.getElementById('remainingFats').innerHTML = 
                        remainingFats >= 0 
                        ? `<span class="remaining-good">${Math.round(remainingFats)}</span>` 
                        : `<span class="remaining-over">${Math.round(Math.abs(remainingFats))}</span>`;
                } else {
                    document.getElementById('remainingFats').innerHTML = '';
                }
            } else {
                // Clear remaining displays if no goals
                document.getElementById('remainingProtein').innerHTML = '';
                document.getElementById('remainingCarbs').innerHTML = '';
                document.getElementById('remainingFats').innerHTML = '';
                document.getElementById('remainingCalories').innerHTML = '';
            }
            
            // Update progress bars
            if (dailyGoals) {
                const pPct = dailyGoals.protein ? Math.min((totalProtein / dailyGoals.protein) * 100, 100) : 0;
                const calPct = dailyGoals.calories ? Math.min((totalCalories / dailyGoals.calories) * 100, 100) : 0;
                const cPct = dailyGoals.carbs ? Math.min((totalCarbs / dailyGoals.carbs) * 100, 100) : 0;
                const fPct = dailyGoals.fats ? Math.min((totalFats / dailyGoals.fats) * 100, 100) : 0;
                
                document.getElementById('proteinBar').style.width = pPct + '%';
                document.getElementById('proteinBar').style.background = totalProtein <= dailyGoals.protein ? 'var(--accent-green)' : 'var(--accent-red)';
                
                document.getElementById('caloriesBar').style.width = calPct + '%';
                document.getElementById('caloriesBar').style.background = totalCalories <= dailyGoals.calories ? 'var(--accent-green)' : 'var(--accent-red)';
                
                if (dailyGoals.carbs) {
                    document.getElementById('carbsBar').style.width = cPct + '%';
                    document.getElementById('carbsBar').style.background = totalCarbs <= dailyGoals.carbs ? 'var(--accent-green)' : 'var(--accent-red)';
                } else {
                    document.getElementById('carbsBar').style.width = '0%';
                }
                
                if (dailyGoals.fats) {
                    document.getElementById('fatsBar').style.width = fPct + '%';
                    document.getElementById('fatsBar').style.background = totalFats <= dailyGoals.fats ? 'var(--accent-green)' : 'var(--accent-red)';
                } else {
                    document.getElementById('fatsBar').style.width = '0%';
                }
            } else {
                document.getElementById('proteinBar').style.width = '0%';
                document.getElementById('caloriesBar').style.width = '0%';
                document.getElementById('carbsBar').style.width = '0%';
                document.getElementById('fatsBar').style.width = '0%';
            }
        }

        // Export saved meals to CSV
        function exportSavedMeals() {
            if (savedMeals.length === 0) {
                alert('No saved meals to export!');
                return;
            }

            // Create detailed CSV with meal contents
            const csvRows = ['Meal Name,Total Servings,Food Name,Amount,Unit,Protein,Carbs,Fats,Fiber,Calories'];
            
            savedMeals.forEach(meal => {
                meal.foods.forEach((food, index) => {
                    const mealName = index === 0 ? meal.name : '';
                    const totalServings = index === 0 ? meal.totalServings : '';
                    
                    csvRows.push([
                        mealName ? `"${mealName}"` : '',
                        totalServings,
                        `"${food.name}"`,
                        food.amount,
                        food.unit,
                        food.protein,
                        food.carbs,
                        food.fats,
                        food.fiber || 0,
                        food.calories || (food.protein * 4 + food.carbs * 4 + food.fats * 9)
                    ].join(','));
                });
            });

            const csv = csvRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `saved-meals-${getLocalDateString()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import saved meals from CSV
        function importSavedMeals(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file is empty or invalid!');
                        return;
                    }

                    const meals = [];
                    let currentMeal = null;

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        
                        // Parse CSV line handling quoted values
                        const parts = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                parts.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        parts.push(current.trim());

                        if (parts.length < 10) continue;

                        const mealName = parts[0];
                        const totalServings = parts[1];
                        const foodName = parts[2];
                        const amount = parseFloat(parts[3]);
                        const unit = parts[4];
                        const protein = parseFloat(parts[5]);
                        const carbs = parseFloat(parts[6]);
                        const fats = parseFloat(parts[7]);
                        const fiber = parseFloat(parts[8]) || 0;
                        const calories = parseFloat(parts[9]) || (protein * 4 + carbs * 4 + fats * 9);

                        // New meal starts
                        if (mealName) {
                            if (currentMeal) {
                                meals.push(currentMeal);
                            }
                            currentMeal = {
                                id: Date.now() + Math.random(),
                                name: mealName,
                                totalServings: parseFloat(totalServings) || 1,
                                foods: []
                            };
                        }

                        // Add food to current meal
                        if (currentMeal && foodName) {
                            currentMeal.foods.push({
                                name: foodName,
                                servingAmount: amount,
                                servingUnit: unit,
                                amount: amount,
                                unit: unit,
                                protein: protein,
                                carbs: carbs,
                                fats: fats,
                                fiber: fiber,
                                calories: calories
                            });
                        }
                    }

                    // Add last meal
                    if (currentMeal) {
                        meals.push(currentMeal);
                    }

                    if (meals.length === 0) {
                        alert('No valid meal entries found in CSV!');
                        return;
                    }

                    // Calculate per-serving macros for each meal
                    meals.forEach(meal => {
                        let totalProtein = 0, totalCarbs = 0, totalFats = 0, totalFiber = 0, totalCalories = 0;
                        
                        meal.foods.forEach(food => {
                            totalProtein += food.protein;
                            totalCarbs += food.carbs;
                            totalFats += food.fats;
                            totalFiber += food.fiber;
                            totalCalories += food.calories;
                        });

                        meal.perServing = {
                            protein: totalProtein / meal.totalServings,
                            carbs: totalCarbs / meal.totalServings,
                            fats: totalFats / meal.totalServings,
                            fiber: totalFiber / meal.totalServings,
                            calories: totalCalories / meal.totalServings
                        };
                    });

                    // Check for duplicates and only add new meals
                    let addedCount = 0;
                    let skippedCount = 0;
                    const duplicates = [];

                    meals.forEach(newMeal => {
                        const existingMeal = savedMeals.find(m => 
                            m.name.toLowerCase() === newMeal.name.toLowerCase()
                        );
                        
                        if (existingMeal) {
                            skippedCount++;
                            duplicates.push(newMeal.name);
                        } else {
                            savedMeals.push(newMeal);
                            addedCount++;
                        }
                    });

                    localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
                    renderSavedMeals();
                    updateMealSelector();
                    syncToFirebase();
                    
                    // Show detailed results
                    let message = `Import Complete!\n\n`;
                    message += `‚úÖ Added: ${addedCount} new meals\n`;
                    message += `‚è≠Ô∏è Skipped: ${skippedCount} duplicates\n`;
                    message += `üìä Total meals: ${savedMeals.length}`;
                    
                    if (duplicates.length > 0 && duplicates.length <= 10) {
                        message += `\n\nSkipped duplicates:\n${duplicates.join(', ')}`;
                    } else if (duplicates.length > 10) {
                        message += `\n\nSkipped duplicates:\n${duplicates.slice(0, 10).join(', ')}\n...and ${duplicates.length - 10} more`;
                    }
                    
                    alert(message);
                    event.target.value = '';
                } catch (error) {
                    alert('Error importing CSV: ' + error.message);
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
        }

        // Export food database to CSV
        function exportFoodDatabase() {
            const foods = foodDatabase;
            if (foods.length === 0) {
                alert('No foods to export!');
                return;
            }

            const headers = ['id', 'name', 'servingAmount', 'servingUnit', 'protein', 'carbs', 'fats', 'fiber', 'calories', 'customCalories'];
            const csvRows = [
                headers.join(','),
                ...foods.map(f => {
                    return headers.map(h => {
                        const val = f[h];
                        if (val === undefined || val === null) return '';
                        // Escape values that contain commas
                        if (typeof val === 'string' && val.includes(',')) {
                            return `"${val}"`;
                        }
                        return val;
                    }).join(',');
                })
            ];
            
            const csv = csvRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `food-database-${getLocalDateString()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import food database from CSV
        function importFoodDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file is empty or invalid!');
                        return;
                    }

                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    // Validate headers
                    const requiredHeaders = ['name', 'servingAmount', 'servingUnit', 'protein', 'carbs', 'fats'];
                    const hasRequiredHeaders = requiredHeaders.every(h => headers.includes(h));
                    
                    if (!hasRequiredHeaders) {
                        alert('CSV must have columns: name, servingAmount, servingUnit, protein, carbs, fats, fiber, calories');
                        return;
                    }

                    const foods = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        // Handle quoted values that may contain commas
                        const values = [];
                        let currentValue = '';
                        let inQuotes = false;
                        
                        for (let char of line) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(currentValue.trim());
                                currentValue = '';
                            } else {
                                currentValue += char;
                            }
                        }
                        values.push(currentValue.trim());

                        const food = {};
                        headers.forEach((h, idx) => {
                            const val = values[idx];
                            if (!val || val === '') return;
                            
                            if (h === 'id') {
                                food[h] = parseInt(val) || Date.now() + i;
                            } else if (['servingAmount', 'protein', 'carbs', 'fats', 'fiber', 'calories'].includes(h)) {
                                food[h] = parseFloat(val) || 0;
                            } else if (h === 'customCalories') {
                                food[h] = val === 'true' || val === '1';
                            } else {
                                food[h] = val;
                            }
                        });

                        // Ensure required fields
                        if (food.name && food.servingAmount && food.servingUnit) {
                            // Set defaults for missing fields
                            food.protein = food.protein || 0;
                            food.carbs = food.carbs || 0;
                            food.fats = food.fats || 0;
                            food.fiber = food.fiber || 0;
                            if (!food.id) food.id = Date.now() + i;
                            if (!food.calories) {
                                food.calories = food.protein * 4 + food.carbs * 4 + food.fats * 9;
                                food.customCalories = false;
                            }
                            foods.push(food);
                        }
                    }

                    if (foods.length === 0) {
                        alert('No valid food entries found in CSV!');
                        return;
                    }

                    // Check for duplicates and only add new foods
                    let addedCount = 0;
                    let skippedCount = 0;
                    const duplicates = [];

                    foods.forEach(newFood => {
                        const existingFood = foodDatabase.find(f => 
                            f.name.toLowerCase() === newFood.name.toLowerCase()
                        );
                        
                        if (existingFood) {
                            // Duplicate found - skip it
                            skippedCount++;
                            duplicates.push(newFood.name);
                        } else {
                            // New food - add it
                            foodDatabase.push(newFood);
                            addedCount++;
                        }
                    });

                    localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                    renderFoodList();
                    updateFoodSelectors();
                    syncToFirebase(); // Sync to cloud
                    
                    // Show detailed results
                    let message = `Import Complete!\n\n`;
                    message += `‚úÖ Added: ${addedCount} new foods\n`;
                    message += `‚è≠Ô∏è Skipped: ${skippedCount} duplicates\n`;
                    message += `üìä Total foods in database: ${foodDatabase.length}`;
                    
                    if (duplicates.length > 0 && duplicates.length <= 10) {
                        message += `\n\nSkipped duplicates:\n${duplicates.join(', ')}`;
                    } else if (duplicates.length > 10) {
                        message += `\n\nSkipped duplicates:\n${duplicates.slice(0, 10).join(', ')}\n...and ${duplicates.length - 10} more`;
                    }
                    
                    alert(message);
                    
                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    alert('Error importing CSV: ' + error.message);
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
        }

        // Clear day functionality
        function clearDay() {
            if (todaysMeals.length === 0) {
                return; // Nothing to clear
            }

            if (confirm('Clear all meals from today? You can undo this action.')) {
                // Backup current meals for undo
                clearedMealsBackup = JSON.parse(JSON.stringify(todaysMeals));
                
                // Clear the day
                todaysMeals = [];
                localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                syncToFirebase(); // Sync to cloud
                
                // Show undo button
                document.getElementById('undoClearBtn').style.display = 'block';
                
                // Hide undo button after 10 seconds
                setTimeout(() => {
                    document.getElementById('undoClearBtn').style.display = 'none';
                    clearedMealsBackup = null;
                }, 10000);
                
                renderDayMeals();
                calculateDayTotals();
            }
        }

        function undoClear() {
            if (clearedMealsBackup) {
                todaysMeals = JSON.parse(JSON.stringify(clearedMealsBackup));
                localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                syncToFirebase(); // Sync to cloud
                
                clearedMealsBackup = null;
                document.getElementById('undoClearBtn').style.display = 'none';
                
                renderDayMeals();
                calculateDayTotals();
            }
        }

        // Goals management functions
        function toggleGoalsEdit() {
            const form = document.getElementById('goalsForm');
            const display = document.getElementById('goalsDisplay');
            const btnText = document.getElementById('goalsEditBtnText');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                display.style.display = 'none';
                btnText.textContent = 'Cancel';
                
                // Load existing goals into form
                if (dailyGoals) {
                    document.getElementById('goalProtein').value = dailyGoals.protein || '';
                    document.getElementById('goalCalories').value = dailyGoals.calories || '';
                    document.getElementById('goalCarbs').value = dailyGoals.carbs || '';
                    document.getElementById('goalFats').value = dailyGoals.fats || '';
                }
            } else {
                form.style.display = 'none';
                if (dailyGoals) {
                    display.style.display = 'block';
                }
                btnText.textContent = 'Edit Goals';
            }
        }

        function saveGoals() {
            const protein = parseFloat(document.getElementById('goalProtein').value);
            const calories = parseFloat(document.getElementById('goalCalories').value);
            const carbs = document.getElementById('goalCarbs').value ? parseFloat(document.getElementById('goalCarbs').value) : null;
            const fats = document.getElementById('goalFats').value ? parseFloat(document.getElementById('goalFats').value) : null;
            
            if (!protein || !calories) {
                alert('Please set at least Protein and Calorie goals');
                return;
            }
            
            dailyGoals = { protein, calories, carbs, fats };
            localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
            
            // Update display
            displayGoals();
            toggleGoalsEdit();
            calculateDayTotals();
        }

        function clearGoals() {
            if (confirm('Clear all goals?')) {
                dailyGoals = null;
                localStorage.removeItem('dailyGoals');
                document.getElementById('goalsForm').style.display = 'none';
                document.getElementById('goalsDisplay').style.display = 'none';
                document.getElementById('goalsEditBtnText').textContent = 'Set Goals';
                
                // Clear form inputs
                document.getElementById('goalProtein').value = '';
                document.getElementById('goalCalories').value = '';
                document.getElementById('goalCarbs').value = '';
                document.getElementById('goalFats').value = '';
                
                calculateDayTotals();
            }
        }

        function displayGoals() {
            if (!dailyGoals) {
                document.getElementById('goalsDisplay').style.display = 'none';
                return;
            }
            
            document.getElementById('displayGoalProtein').textContent = dailyGoals.protein;
            document.getElementById('displayGoalCalories').textContent = dailyGoals.calories;
            
            // Show/hide optional goals
            if (dailyGoals.carbs !== null && dailyGoals.carbs !== undefined) {
                document.getElementById('displayGoalCarbs').textContent = dailyGoals.carbs;
                document.getElementById('displayGoalCarbsContainer').style.display = 'block';
            } else {
                document.getElementById('displayGoalCarbsContainer').style.display = 'none';
            }
            
            if (dailyGoals.fats !== null && dailyGoals.fats !== undefined) {
                document.getElementById('displayGoalFats').textContent = dailyGoals.fats;
                document.getElementById('displayGoalFatsContainer').style.display = 'block';
            } else {
                document.getElementById('displayGoalFatsContainer').style.display = 'none';
            }
            
            document.getElementById('goalsDisplay').style.display = 'block';
        }

        // Close Out Day function
        function closeOutDay() {
            // Get selected date or use today
            const selectedDate = document.getElementById('closeOutDate').value;
            if (!selectedDate) {
                alert('Please select a date for this close out');
                return;
            }

            // Calculate current totals
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFats = 0;
            let totalCalories = 0;

            todaysMeals.forEach(item => {
                const itemType = item.type || 'meal';
                const amount = item.amount !== undefined ? item.amount : (item.servings || 1);
                
                if (itemType === 'food') {
                    totalProtein += item.macros.protein;
                    totalCarbs += item.macros.carbs;
                    totalFats += item.macros.fats;
                    totalCalories += item.macros.calories || (item.macros.protein * 4 + item.macros.carbs * 4 + item.macros.fats * 9);
                } else {
                    totalProtein += item.macros.protein * amount;
                    totalCarbs += item.macros.carbs * amount;
                    totalFats += item.macros.fats * amount;
                    totalCalories += (item.macros.calories || (item.macros.protein * 4 + item.macros.carbs * 4 + item.macros.fats * 9)) * amount;
                }
            });

            if (totalCalories === 0) {
                alert('No meals tracked today. Add some meals before closing out.');
                return;
            }

            // Check if already closed out for this date
            const existingIndex = dayHistory.findIndex(entry => entry.date === selectedDate);
            
            const entry = {
                date: selectedDate,
                calories: parseFloat(totalCalories.toFixed(1)),
                protein: parseFloat(totalProtein.toFixed(1)),
                carbs: parseFloat(totalCarbs.toFixed(1)),
                fats: parseFloat(totalFats.toFixed(1)),
                calorieGoal: dailyGoals ? dailyGoals.calories : null,
                proteinGoal: dailyGoals ? dailyGoals.protein : null
            };

            if (existingIndex >= 0) {
                if (confirm(`Already closed out for ${selectedDate}. Update with current data?`)) {
                    dayHistory[existingIndex] = entry;
                } else {
                    return;
                }
            } else {
                dayHistory.push(entry);
            }

            // Sort by date (newest first)
            dayHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
            syncToFirebase();

            renderHistory();
            drawHistoryChart();
            
            alert(`Day closed out for ${selectedDate}! Data saved to history.`);
        }

        // Render history table
        function renderHistory() {
            const tbody = document.getElementById('historyTableBody');
            const emptyMessage = document.getElementById('emptyHistoryMessage');

            console.log('üìä Rendering history, entries:', dayHistory.length);
            
            // Filter to only show entries with valid dates (not meal objects)
            const validHistory = dayHistory.filter(entry => {
                // Must have a date field that looks like YYYY-MM-DD
                return entry.date && /^\d{4}-\d{2}-\d{2}$/.test(entry.date);
            });
            
            if (validHistory.length === 0) {
                tbody.innerHTML = '';
                emptyMessage.style.display = 'block';
                console.log('‚ö†Ô∏è No valid history to display');
                return;
            }

            emptyMessage.style.display = 'none';
            console.log('‚úÖ Rendering', validHistory.length, 'valid history entries (filtered from', dayHistory.length, 'total)');

            tbody.innerHTML = validHistory.map((entry, index) => {
                const rowBg = 'transparent';
                const calDiff = entry.calorieGoal ? entry.calories - entry.calorieGoal : null;
                const proteinDiff = entry.proteinGoal ? entry.protein - entry.proteinGoal : null;

                return `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid var(--border);" id="historyRow${index}">
                        <td style="padding: 8px; font-weight: 600;">${entry.date}</td>
                        <td style="padding: 8px; text-align: center;">${entry.calories}</td>
                        <td style="padding: 8px; text-align: center;">
                            ${entry.calorieGoal || '-'}
                            ${calDiff !== null ? `<br><span style="font-size: 0.75rem; color: ${calDiff >= 0 ? '#dc2626' : '#10b981'};">${calDiff > 0 ? '+' : ''}${calDiff.toFixed(0)}</span>` : ''}
                        </td>
                        <td style="padding: 8px; text-align: center; color: var(--protein); font-weight: 600;">${entry.protein}g</td>
                        <td style="padding: 8px; text-align: center;">
                            ${entry.proteinGoal ? entry.proteinGoal + 'g' : '-'}
                            ${proteinDiff !== null ? `<br><span style="font-size: 0.75rem; color: ${proteinDiff >= 0 ? '#10b981' : '#dc2626'};">${proteinDiff > 0 ? '+' : ''}${proteinDiff.toFixed(0)}g</span>` : ''}
                        </td>
                        <td style="padding: 8px; text-align: center; color: var(--carbs); font-weight: 600;">${entry.carbs}g</td>
                        <td style="padding: 8px; text-align: center; color: var(--accent-green); font-weight: 600;">${entry.fats}g</td>
                        <td style="padding: 8px; text-align: center;">
                            <button onclick="toggleEditHistoryEntry(${index})" class="btn-success btn-sm" style="margin-right:2px;">Edit</button>
                            <button onclick="deleteHistoryEntry('${entry.date}')" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Del</button>
                        </td>
                    </tr>
                    <tr id="editRow${index}" style="display: none; background: #fffbeb; border-bottom: 2px solid #f59e0b;">
                        <td colspan="8" style="padding: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; font-weight: 600;">Date</label>
                                    <input type="date" id="editDate${index}" value="${entry.date}" style="width: 100%; padding: 6px; border: 2px solid #f59e0b; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; font-weight: 600;">Calories</label>
                                    <input type="number" id="editCalories${index}" value="${entry.calories}" step="0.1" style="width: 100%; padding: 6px; border: 2px solid #f59e0b; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; font-weight: 600;">Protein (g)</label>
                                    <input type="number" id="editProtein${index}" value="${entry.protein}" step="0.1" style="width: 100%; padding: 6px; border: 2px solid #f59e0b; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; font-weight: 600;">Carbs (g)</label>
                                    <input type="number" id="editCarbs${index}" value="${entry.carbs}" step="0.1" style="width: 100%; padding: 6px; border: 2px solid #f59e0b; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; font-weight: 600;">Fats (g)</label>
                                    <input type="number" id="editFats${index}" value="${entry.fats}" step="0.1" style="width: 100%; padding: 6px; border: 2px solid #f59e0b; border-radius: 4px;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="saveEditHistoryEntry(${index})" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Save Changes</button>
                                <button onclick="cancelEditHistoryEntry(${index})" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Draw history chart
        // High-DPI canvas setup - makes charts crisp on iPhone/retina and responsive to container
        function setupCanvas(canvasId, desiredHeight) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            const container = canvas.parentElement;
            const dpr = window.devicePixelRatio || 1;
            const displayWidth = container.clientWidth;
            const displayHeight = desiredHeight || Math.round(displayWidth * 0.5);
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            canvas.width = Math.round(displayWidth * dpr);
            canvas.height = Math.round(displayHeight * dpr);
            const ctx = canvas.getContext('2d');
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);  // Reset + scale in one call
            ctx.clearRect(0, 0, displayWidth, displayHeight);
            // Return logical dimensions for drawing
            return { canvas, ctx, width: displayWidth, height: displayHeight };
        }

        function drawHistoryChart() {
            // Draw all four charts
            drawProteinChart();
            drawCalorieChart();
            drawCarbsChart();
            drawFatsChart();
        }

        function drawProteinChart() {
            const setup = setupCanvas('proteinChart', 200);
            if (!setup) return;
            const { canvas, ctx, width: W, height: H } = setup;

            // Get toggle states
            const showDailyBars = document.getElementById('showDailyBars')?.checked ?? true;
            const show7DayAvg = document.getElementById('show7DayAvg')?.checked ?? true;
            const showGoalLine = document.getElementById('showGoalLine')?.checked ?? true;

            if (dayHistory.length === 0) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '14px DM Sans, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No protein data yet', W / 2, H / 2);
                document.getElementById('proteinStats').innerHTML = '<div style="text-align: center; color: #999;">Start tracking to see stats</div>';
                return;
            }

            // Get last 30 days and calculate 7-day rolling averages
            const recentData = dayHistory.slice(0, 30).reverse();
            recentData.forEach((entry, index) => {
                const last7 = recentData.slice(Math.max(0, index - 6), index + 1);
                const avg = last7.reduce((sum, e) => sum + e.protein, 0) / last7.length;
                entry.protein7DayAvg = avg;
            });

            // Chart dimensions
            const padding = 50;
            const chartWidth = W - padding * 2;
            const chartHeight = H - padding * 2;

            // Find max value
            const maxProtein = Math.max(
                ...recentData.map(d => Math.max(d.protein, d.proteinGoal || 0, d.protein7DayAvg || 0))
            ) * 1.1;

            // Draw grid lines
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (chartHeight / 4) * i;
                const value = maxProtein - (maxProtein / 4) * i;
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(W - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#94a3b8';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(value) + 'g', padding - 5, y + 4);
            }

            // Draw axes
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, H - padding);
            ctx.lineTo(W - padding, H - padding);
            ctx.stroke();

            const getX = (index) => padding + (chartWidth / (recentData.length - 1)) * index;
            const getY = (protein) => H - padding - (protein / maxProtein) * chartHeight;

            // Draw goal line (if enabled)
            const hasProteinGoal = dailyGoals && dailyGoals.protein;
            if (showGoalLine && hasProteinGoal) {
                ctx.strokeStyle = '#93c5fd';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                const goalY = getY(dailyGoals.protein);
                ctx.moveTo(padding, goalY);
                ctx.lineTo(W - padding, goalY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Goal label
                ctx.fillStyle = '#3b82f6';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Goal: ${dailyGoals.protein}g`, padding + 5, goalY - 5);
            }

            // Draw 7-day average line (if enabled)
            if (show7DayAvg) {
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                ctx.beginPath();
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.protein7DayAvg);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Draw daily protein bars (if enabled)
            if (showDailyBars) {
                const barWidth = Math.min(chartWidth / recentData.length * 0.6, 15);
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.protein);
                    const height = H - padding - y;
                    
                    ctx.fillStyle = entry.protein >= (entry.proteinGoal || 0) ? '#3b82f6' : '#93c5fd';
                    ctx.fillRect(x - barWidth / 2, y, barWidth, height);
                });
            }

            // Draw points on 7-day line (if enabled)
            if (show7DayAvg) {
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.protein7DayAvg);
                    ctx.fillStyle = '#10b981';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            // Date labels (every nth date)
            ctx.fillStyle = '#94a3b8';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelInterval = Math.max(1, Math.floor(recentData.length / 8));
            recentData.forEach((entry, i) => {
                if (i % labelInterval === 0 || i === recentData.length - 1) {
                    const dateLabel = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    ctx.fillText(dateLabel, getX(i), H - padding + 20);
                }
            });

            // Legend
            ctx.font = '11px Arial';
            ctx.textAlign = 'left';
            
            if (showDailyBars) {
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(padding, 10, 15, 10);
                ctx.fillStyle = '#1e293b';
                ctx.fillText('Daily', padding + 20, 18);
            }
            
            if (show7DayAvg) {
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(padding + 80, 15);
                ctx.lineTo(padding + 95, 15);
                ctx.stroke();
                ctx.fillStyle = '#1e293b';
                ctx.fillText('7-Day Avg', padding + 100, 18);
            }

            // Calculate and display stats
            const last7Days = recentData.slice(-7);
            const avg7Day = last7Days.reduce((sum, e) => sum + e.protein, 0) / last7Days.length;
            const goal = dailyGoals ? dailyGoals.protein : 0;
            const daysOverGoal = dailyGoals ? recentData.filter(e => e.protein >= dailyGoals.protein).length : 0;
            const avgDiff = avg7Day - goal;

            document.getElementById('proteinStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">7-Day Average</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--protein);">${avg7Day.toFixed(1)}g</div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Goal</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--protein);">${goal}g</div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Difference</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: ${avgDiff >= 0 ? '#10b981' : '#dc2626'};">
                            ${avgDiff >= 0 ? '+' : ''}${avgDiff.toFixed(1)}g
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Hit Goal</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--protein);">${daysOverGoal}/${recentData.length} days</div>
                    </div>
                </div>
            `;
        }

        function drawCalorieChart() {
            const setup = setupCanvas('calorieChart', 200);
            if (!setup) return;
            const { canvas, ctx, width: W, height: H } = setup;

            // Get toggle states
            const showDailyBars = document.getElementById('showDailyBars')?.checked ?? true;
            const show7DayAvg = document.getElementById('show7DayAvg')?.checked ?? true;
            const showGoalLine = document.getElementById('showGoalLine')?.checked ?? true;

            if (dayHistory.length === 0) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '14px DM Sans, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No calorie data yet', W / 2, H / 2);
                document.getElementById('calorieStats').innerHTML = '<div style="text-align: center; color: #999;">Start tracking to see stats</div>';
                return;
            }

            // Get last 30 days and calculate 7-day rolling averages
            const recentData = dayHistory.slice(0, 30).reverse();
            recentData.forEach((entry, index) => {
                const last7 = recentData.slice(Math.max(0, index - 6), index + 1);
                const avg = last7.reduce((sum, e) => sum + e.calories, 0) / last7.length;
                entry.calorie7DayAvg = avg;
            });

            // Chart dimensions
            const padding = 50;
            const chartWidth = W - padding * 2;
            const chartHeight = H - padding * 2;

            // Find max value
            const maxCalories = Math.max(
                ...recentData.map(d => Math.max(d.calories, d.calorieGoal || 0, d.calorie7DayAvg || 0))
            ) * 1.1;

            // Draw grid lines
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (chartHeight / 4) * i;
                const value = maxCalories - (maxCalories / 4) * i;
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(W - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#94a3b8';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(value), padding - 5, y + 4);
            }

            // Draw axes
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, H - padding);
            ctx.lineTo(W - padding, H - padding);
            ctx.stroke();

            const getX = (index) => padding + (chartWidth / (recentData.length - 1)) * index;
            const getY = (calories) => H - padding - (calories / maxCalories) * chartHeight;

            // Draw goal line (if enabled)
            const hasCalorieGoal = dailyGoals && dailyGoals.calories;
            if (showGoalLine && hasCalorieGoal) {
                ctx.strokeStyle = '#fcd34d';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                const goalY = getY(dailyGoals.calories);
                ctx.moveTo(padding, goalY);
                ctx.lineTo(W - padding, goalY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Goal label
                ctx.fillStyle = '#d97706';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Goal: ${dailyGoals.calories}`, padding + 5, goalY - 5);
            }

            // Draw 7-day average line (if enabled)
            if (show7DayAvg) {
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 3;
                ctx.beginPath();
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.calorie7DayAvg);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Draw daily calorie bars (if enabled)
            if (showDailyBars) {
                const barWidth = Math.min(chartWidth / recentData.length * 0.6, 15);
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.calories);
                    const height = H - padding - y;
                    
                    const withinGoal = entry.calorieGoal && Math.abs(entry.calories - entry.calorieGoal) <= entry.calorieGoal * 0.1;
                    ctx.fillStyle = withinGoal ? '#f59e0b' : '#fcd34d';
                    ctx.fillRect(x - barWidth / 2, y, barWidth, height);
                });
            }

            // Draw points on 7-day line (if enabled)
            if (show7DayAvg) {
            recentData.forEach((entry, i) => {
                const x = getX(i);
                const y = getY(entry.calorie7DayAvg);
                ctx.fillStyle = '#dc2626';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
            }

            // Date labels (every nth date)
            ctx.fillStyle = '#94a3b8';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelInterval = Math.max(1, Math.floor(recentData.length / 8));
            recentData.forEach((entry, i) => {
                if (i % labelInterval === 0 || i === recentData.length - 1) {
                    const dateLabel = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    ctx.fillText(dateLabel, getX(i), H - padding + 20);
                }
            });

            // Legend
            ctx.font = '11px Arial';
            ctx.textAlign = 'left';
            
            ctx.fillStyle = '#d97706';
            ctx.fillRect(padding, 10, 15, 10);
            ctx.fillStyle = '#1e293b';
            ctx.fillText('Daily', padding + 20, 18);
            
            ctx.strokeStyle = '#dc2626';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(padding + 80, 15);
            ctx.lineTo(padding + 95, 15);
            ctx.stroke();
            ctx.fillStyle = '#1e293b';
            ctx.fillText('7-Day Avg', padding + 100, 18);

            // Calculate and display stats
            const last7Days = recentData.slice(-7);
            const avg7Day = last7Days.reduce((sum, e) => sum + e.calories, 0) / last7Days.length;
            const goal = dailyGoals ? dailyGoals.calories : 0;
            const daysWithinGoal = dailyGoals ? recentData.filter(e => {
                return Math.abs(e.calories - dailyGoals.calories) <= dailyGoals.calories * 0.1;
            }).length : 0;
            const avgDiff = avg7Day - goal;

            document.getElementById('calorieStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">7-Day Average</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--carbs);">${Math.round(avg7Day)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Goal</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--carbs);">${goal}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Difference</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: ${avgDiff >= -goal * 0.1 && avgDiff <= goal * 0.1 ? '#10b981' : '#dc2626'};">
                            ${avgDiff >= 0 ? '+' : ''}${Math.round(avgDiff)}
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Within ¬±10%</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--carbs);">${daysWithinGoal}/${recentData.length} days</div>
                    </div>
                </div>
            `;
        }

        function redrawAllCharts() {
            // Redraw all charts with current toggle settings
            drawProteinChart();
            drawCalorieChart();
            drawCarbsChart();
            drawFatsChart();
        }

        function drawCarbsChart() {
            const setup = setupCanvas('carbsChart', 200);
            if (!setup) return;
            const { canvas, ctx, width: W, height: H } = setup;

            // Get toggle states
            const showDailyBars = document.getElementById('showDailyBars')?.checked ?? true;
            const show7DayAvg = document.getElementById('show7DayAvg')?.checked ?? true;
            const showGoalLine = document.getElementById('showGoalLine')?.checked ?? true;

            if (dayHistory.length === 0) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '14px DM Sans, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No carbs data yet', W / 2, H / 2);
                document.getElementById('carbsStats').innerHTML = '<div style="text-align: center; color: #999;">Start tracking to see stats</div>';
                return;
            }

            // Get last 30 days and calculate 7-day rolling averages
            const recentData = dayHistory.slice(0, 30).reverse();
            recentData.forEach((entry, index) => {
                const last7 = recentData.slice(Math.max(0, index - 6), index + 1);
                const avg = last7.reduce((sum, e) => sum + e.carbs, 0) / last7.length;
                entry.carbs7DayAvg = avg;
            });

            // Chart dimensions
            const padding = 50;
            const chartWidth = W - padding * 2;
            const chartHeight = H - padding * 2;

            // Find max value
            const hasGoal = dailyGoals && dailyGoals.carbs;
            const maxCarbs = Math.max(
                ...recentData.map(d => Math.max(d.carbs, hasGoal ? dailyGoals.carbs : 0, d.carbs7DayAvg || 0))
            ) * 1.1;

            // Draw grid lines
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (chartHeight / 4) * i;
                const value = maxCarbs - (maxCarbs / 4) * i;
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(W - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#94a3b8';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(value) + 'g', padding - 5, y + 4);
            }

            // Draw axes
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, H - padding);
            ctx.lineTo(W - padding, H - padding);
            ctx.stroke();

            const getX = (index) => padding + (chartWidth / (recentData.length - 1)) * index;
            const getY = (carbs) => H - padding - (carbs / maxCarbs) * chartHeight;

            // Draw goal line if exists (and enabled)
            if (showGoalLine && hasGoal) {
            
                ctx.strokeStyle = '#fdba74';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                const goalY = getY(dailyGoals.carbs);
                ctx.moveTo(padding, goalY);
                ctx.lineTo(W - padding, goalY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#d97706';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Goal: ${dailyGoals.carbs}g`, padding + 5, goalY - 5);
            }

            // Draw 7-day average line (if enabled)
            if (show7DayAvg) {
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 3;
                ctx.beginPath();
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.carbs7DayAvg);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Draw daily carbs bars (if enabled)
            if (showDailyBars) {
                const barWidth = Math.min(chartWidth / recentData.length * 0.6, 15);
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.carbs);
                    const height = H - padding - y;
                    
                    const withinGoal = hasGoal && Math.abs(entry.carbs - dailyGoals.carbs) <= dailyGoals.carbs * 0.1;
                    ctx.fillStyle = withinGoal ? '#f59e0b' : '#fdba74';
                    ctx.fillRect(x - barWidth / 2, y, barWidth, height);
                });
            }

            // Draw points on 7-day line (if enabled)
            if (show7DayAvg) {
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.carbs7DayAvg);
                    ctx.fillStyle = '#dc2626';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            // Date labels
            ctx.fillStyle = '#94a3b8';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelInterval = Math.max(1, Math.floor(recentData.length / 8));
            recentData.forEach((entry, i) => {
                if (i % labelInterval === 0 || i === recentData.length - 1) {
                    const dateLabel = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    ctx.fillText(dateLabel, getX(i), H - padding + 20);
                }
            });

            // Legend
            ctx.font = '11px Arial';
            ctx.textAlign = 'left';
            
            if (showDailyBars) {
                ctx.fillStyle = '#d97706';
                ctx.fillRect(padding, 10, 15, 10);
                ctx.fillStyle = '#1e293b';
                ctx.fillText('Daily', padding + 20, 18);
            }
            
            if (show7DayAvg) {
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(padding + 80, 15);
                ctx.lineTo(padding + 95, 15);
                ctx.stroke();
                ctx.fillStyle = '#1e293b';
                ctx.fillText('7-Day Avg', padding + 100, 18);
            }

            // Calculate and display stats
            const last7Days = recentData.slice(-7);
            const avg7Day = last7Days.reduce((sum, e) => sum + e.carbs, 0) / last7Days.length;
            const goal = hasGoal ? dailyGoals.carbs : 0;
            const daysWithinGoal = hasGoal ? recentData.filter(e => Math.abs(e.carbs - goal) <= goal * 0.1).length : 0;
            const avgDiff = avg7Day - goal;

            document.getElementById('carbsStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">7-Day Average</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--carbs);">${avg7Day.toFixed(1)}g</div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Goal</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--carbs);">${hasGoal ? goal + 'g' : 'Not set'}</div>
                    </div>
                    ${hasGoal ? `
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Difference</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: ${avgDiff >= -goal * 0.1 && avgDiff <= goal * 0.1 ? '#10b981' : '#dc2626'};">
                            ${avgDiff >= 0 ? '+' : ''}${avgDiff.toFixed(1)}g
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Within ¬±10%</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--carbs);">${daysWithinGoal}/${recentData.length} days</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function drawFatsChart() {
            const setup = setupCanvas('fatsChart', 200);
            if (!setup) return;
            const { canvas, ctx, width: W, height: H } = setup;

            // Get toggle states
            const showDailyBars = document.getElementById('showDailyBars')?.checked ?? true;
            const show7DayAvg = document.getElementById('show7DayAvg')?.checked ?? true;
            const showGoalLine = document.getElementById('showGoalLine')?.checked ?? true;

            if (dayHistory.length === 0) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '14px DM Sans, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No fats data yet', W / 2, H / 2);
                document.getElementById('fatsStats').innerHTML = '<div style="text-align: center; color: #999;">Start tracking to see stats</div>';
                return;
            }

            // Get last 30 days and calculate 7-day rolling averages
            const recentData = dayHistory.slice(0, 30).reverse();
            recentData.forEach((entry, index) => {
                const last7 = recentData.slice(Math.max(0, index - 6), index + 1);
                const avg = last7.reduce((sum, e) => sum + e.fats, 0) / last7.length;
                entry.fats7DayAvg = avg;
            });

            // Chart dimensions
            const padding = 50;
            const chartWidth = W - padding * 2;
            const chartHeight = H - padding * 2;

            // Find max value
            const hasGoal = dailyGoals && dailyGoals.fats;
            const maxFats = Math.max(
                ...recentData.map(d => Math.max(d.fats, hasGoal ? dailyGoals.fats : 0, d.fats7DayAvg || 0))
            ) * 1.1;

            // Draw grid lines
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (chartHeight / 4) * i;
                const value = maxFats - (maxFats / 4) * i;
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(W - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#94a3b8';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(value) + 'g', padding - 5, y + 4);
            }

            // Draw axes
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, H - padding);
            ctx.lineTo(W - padding, H - padding);
            ctx.stroke();

            const getX = (index) => padding + (chartWidth / (recentData.length - 1)) * index;
            const getY = (fats) => H - padding - (fats / maxFats) * chartHeight;

            // Draw goal line if exists (and enabled)
            if (showGoalLine && hasGoal) {
            
                ctx.strokeStyle = '#6ee7b7';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                const goalY = getY(dailyGoals.fats);
                ctx.moveTo(padding, goalY);
                ctx.lineTo(W - padding, goalY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#10b981';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Goal: ${dailyGoals.fats}g`, padding + 5, goalY - 5);
            }

            // Draw 7-day average line (if enabled)
            if (show7DayAvg) {
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 3;
                ctx.beginPath();
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.fats7DayAvg);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Draw daily fats bars (if enabled)
            if (showDailyBars) {
                const barWidth = Math.min(chartWidth / recentData.length * 0.6, 15);
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.fats);
                    const height = H - padding - y;
                    
                    const withinGoal = hasGoal && Math.abs(entry.fats - dailyGoals.fats) <= dailyGoals.fats * 0.1;
                    ctx.fillStyle = withinGoal ? '#10b981' : '#6ee7b7';
                    ctx.fillRect(x - barWidth / 2, y, barWidth, height);
                });
            }

            // Draw points on 7-day line (if enabled)
            if (show7DayAvg) {
                recentData.forEach((entry, i) => {
                    const x = getX(i);
                    const y = getY(entry.fats7DayAvg);
                    ctx.fillStyle = '#dc2626';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            // Date labels
            ctx.fillStyle = '#94a3b8';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            const labelInterval = Math.max(1, Math.floor(recentData.length / 8));
            recentData.forEach((entry, i) => {
                if (i % labelInterval === 0 || i === recentData.length - 1) {
                    const dateLabel = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    ctx.fillText(dateLabel, getX(i), H - padding + 20);
                }
            });

            // Legend
            ctx.font = '11px Arial';
            ctx.textAlign = 'left';
            
            if (showDailyBars) {
                ctx.fillStyle = '#10b981';
                ctx.fillRect(padding, 10, 15, 10);
                ctx.fillStyle = '#1e293b';
                ctx.fillText('Daily', padding + 20, 18);
            }
            
            if (show7DayAvg) {
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(padding + 80, 15);
                ctx.lineTo(padding + 95, 15);
                ctx.stroke();
                ctx.fillStyle = '#1e293b';
                ctx.fillText('7-Day Avg', padding + 100, 18);
            }

            // Calculate and display stats
            const last7Days = recentData.slice(-7);
            const avg7Day = last7Days.reduce((sum, e) => sum + e.fats, 0) / last7Days.length;
            const goal = hasGoal ? dailyGoals.fats : 0;
            const daysWithinGoal = hasGoal ? recentData.filter(e => Math.abs(e.fats - goal) <= goal * 0.1).length : 0;
            const avgDiff = avg7Day - goal;

            document.getElementById('fatsStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">7-Day Average</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-green);">${avg7Day.toFixed(1)}g</div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Goal</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-green);">${hasGoal ? goal + 'g' : 'Not set'}</div>
                    </div>
                    ${hasGoal ? `
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Difference</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: ${avgDiff >= -goal * 0.1 && avgDiff <= goal * 0.1 ? '#10b981' : '#dc2626'};">
                            ${avgDiff >= 0 ? '+' : ''}${avgDiff.toFixed(1)}g
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase;">Within ¬±10%</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-green);">${daysWithinGoal}/${recentData.length} days</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Edit history entry - inline editing
        function toggleEditHistoryEntry(index) {
            const editRow = document.getElementById(`editRow${index}`);
            const isVisible = editRow.style.display !== 'none';
            
            // Hide all other edit rows
            document.querySelectorAll('[id^="editRow"]').forEach(row => {
                row.style.display = 'none';
            });
            
            // Toggle this edit row
            if (!isVisible) {
                editRow.style.display = 'table-row';
            }
        }

        function cancelEditHistoryEntry(index) {
            document.getElementById(`editRow${index}`).style.display = 'none';
        }

        function saveEditHistoryEntry(index) {
            const entry = dayHistory[index];
            const oldDate = entry.date;
            
            const newDate = document.getElementById(`editDate${index}`).value;
            const newCalories = parseFloat(document.getElementById(`editCalories${index}`).value);
            const newProtein = parseFloat(document.getElementById(`editProtein${index}`).value);
            const newCarbs = parseFloat(document.getElementById(`editCarbs${index}`).value);
            const newFats = parseFloat(document.getElementById(`editFats${index}`).value);

            // Check if new date already exists (and it's not the same entry)
            if (newDate !== oldDate && dayHistory.some((e, i) => e.date === newDate && i !== index)) {
                alert('An entry already exists for that date!');
                return;
            }

            // Update entry
            entry.date = newDate;
            entry.calories = newCalories;
            entry.protein = newProtein;
            entry.carbs = newCarbs;
            entry.fats = newFats;

            // Resort by date
            dayHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
            syncToFirebase();
            renderHistory();
            drawHistoryChart();
        }

        // Delete history entry
        function deleteHistoryEntry(date) {
            if (confirm(`Delete entry for ${date}?`)) {
                dayHistory = dayHistory.filter(entry => entry.date !== date);
                localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
                syncToFirebase();
                renderHistory();
                drawHistoryChart();
            }
        }

        // Export history to CSV
        function exportHistory() {
            if (dayHistory.length === 0) {
                alert('No history to export!');
                return;
            }

            const headers = ['date', 'calories', 'calorieGoal', 'protein', 'proteinGoal', 'carbs', 'fats'];
            const csvRows = [
                headers.join(','),
                ...dayHistory.map(entry => {
                    return [
                        entry.date,
                        entry.calories,
                        entry.calorieGoal || '',
                        entry.protein,
                        entry.proteinGoal || '',
                        entry.carbs,
                        entry.fats
                    ].join(',');
                })
            ];

            const csv = csvRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `macro-history-${getLocalDateString()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import history from CSV
        function importHistory(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('CSV file is empty!');
                        return;
                    }

                    const headers = lines[0].split(',').map(h => h.trim());
                    const entries = [];

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        
                        // Helper function to safely parse numbers, returning null for invalid values
                        const safeParseFloat = (value) => {
                            if (!value || value === '' || value === 'null' || value === 'undefined') {
                                return null;
                            }
                            const parsed = parseFloat(value);
                            return isNaN(parsed) ? null : parsed;
                        };
                        
                        const entry = {
                            date: values[0],
                            calories: safeParseFloat(values[1]) || 0,
                            calorieGoal: safeParseFloat(values[2]),
                            protein: safeParseFloat(values[3]) || 0,
                            proteinGoal: safeParseFloat(values[4]),
                            carbs: safeParseFloat(values[5]) || 0,
                            fats: safeParseFloat(values[6]) || 0
                        };

                        if (entry.date && entry.calories) {
                            entries.push(entry);
                        }
                    }

                    if (entries.length === 0) {
                        alert('No valid entries found!');
                        return;
                    }

                    // Check for duplicates and only add new entries
                    let addedCount = 0;
                    let skippedCount = 0;
                    const duplicates = [];

                    entries.forEach(newEntry => {
                        const existingEntry = dayHistory.find(e => e.date === newEntry.date);
                        
                        if (existingEntry) {
                            // Duplicate found - skip it
                            skippedCount++;
                            duplicates.push(newEntry.date);
                        } else {
                            // New entry - add it
                            dayHistory.push(newEntry);
                            addedCount++;
                        }
                    });

                    dayHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem('dayHistory', JSON.stringify(dayHistory));
                    syncToFirebase();

                    renderHistory();
                    drawHistoryChart();

                    // Show detailed results
                    let message = `Import Complete!\n\n`;
                    message += `‚úÖ Added: ${addedCount} new entries\n`;
                    message += `‚è≠Ô∏è Skipped: ${skippedCount} duplicates\n`;
                    message += `üìä Total history entries: ${dayHistory.length}`;
                    
                    if (duplicates.length > 0 && duplicates.length <= 10) {
                        message += `\n\nSkipped duplicates:\n${duplicates.join(', ')}`;
                    } else if (duplicates.length > 10) {
                        message += `\n\nSkipped duplicates:\n${duplicates.slice(0, 10).join(', ')}\n...and ${duplicates.length - 10} more`;
                    }
                    
                    alert(message);
                    event.target.value = '';
                } catch (error) {
                    alert('Error importing CSV: ' + error.message);
                }
            };

            reader.readAsText(file);
        }

        // Weight Tracking Functions
        function addWeightEntry() {
            const date = document.getElementById('weightDate').value;
            const morningWeight = document.getElementById('morningWeight').value;
            const notes = document.getElementById('weightNotes').value.trim();

            if (!date) {
                alert('Please select a date');
                return;
            }

            if (!morningWeight) {
                alert('Please enter morning weight');
                return;
            }

            // Check if entry for this date already exists
            const existingIndex = weightData.findIndex(entry => entry.date === date);

            const entry = {
                date: date,
                morningWeight: morningWeight ? parseFloat(morningWeight) : null,
                notes: notes || null
            };

            if (existingIndex >= 0) {
                if (confirm('Entry for this date already exists. Update it?')) {
                    weightData[existingIndex] = entry;
                } else {
                    return;
                }
            } else {
                weightData.push(entry);
            }

            // Sort by date (newest first)
            weightData.sort((a, b) => new Date(b.date) - new Date(a.date));

            localStorage.setItem('weightData', JSON.stringify(weightData));
            syncToFirebase();

            renderWeightTable();
            drawWeightChart();

            // Clear form
            document.getElementById('weightDate').value = getLocalDateString();
            document.getElementById('morningWeight').value = '';
            document.getElementById('weightNotes').value = '';
        }

        function renderWeightTable() {
            const tbody = document.getElementById('weightTableBody');
            const emptyMessage = document.getElementById('emptyWeightMessage');

            if (weightData.length === 0) {
                tbody.innerHTML = '';
                emptyMessage.style.display = 'block';
                return;
            }

            emptyMessage.style.display = 'none';

            // Calculate 7-day rolling averages
            const sortedByDate = [...weightData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            sortedByDate.forEach((entry, index) => {
                // Get last 7 days of data (including current day)
                const last7Days = sortedByDate.slice(Math.max(0, index - 6), index + 1);
                
                // Get only entries with morning weights
                const weightsOnly = last7Days
                    .filter(e => e.morningWeight !== null && e.morningWeight !== undefined)
                    .map(e => e.morningWeight);
                
                if (weightsOnly.length > 0) {
                    const avg = weightsOnly.reduce((sum, w) => sum + w, 0) / weightsOnly.length;
                    entry.calculated7DayAvg = parseFloat(avg.toFixed(1));
                } else {
                    entry.calculated7DayAvg = null;
                }
            });

            tbody.innerHTML = weightData.map((entry, index) => {
                const rowBg = 'transparent';
                
                // Calculate change from previous entry (using 7-day average)
                let changeText = '-';
                if (index < weightData.length - 1) {
                    const prevEntry = weightData[index + 1];
                    const currentWeight = entry.calculated7DayAvg || entry.morningWeight;
                    const prevWeight = prevEntry.calculated7DayAvg || prevEntry.morningWeight;
                    
                    if (currentWeight && prevWeight) {
                        const change = currentWeight - prevWeight;
                        const changeColor = change < 0 ? '#10b981' : change > 0 ? '#dc2626' : '#666';
                        changeText = `<span style="color: ${changeColor}; font-weight: 600;">${change > 0 ? '+' : ''}${change.toFixed(1)} lb</span>`;
                    }
                }

                // Show calculated 7-day average
                const avgDisplay = entry.calculated7DayAvg ? entry.calculated7DayAvg + ' lb' : '-';

                return `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid var(--border);">
                        <td style="padding: 8px; font-weight: 600;">${entry.date}</td>
                        <td style="padding: 8px; text-align: center; color: var(--protein); font-weight: 600;">${entry.morningWeight ? entry.morningWeight + ' lb' : '-'}</td>
                        <td style="padding: 8px; text-align: center; color: var(--accent-green); font-weight: 600;">${avgDisplay}</td>
                        <td style="padding: 8px; text-align: center;">${changeText}</td>
                        <td style="padding: 8px; font-size: 0.8rem; color: var(--text-muted);">${entry.notes || ''}</td>
                        <td style="padding: 8px; text-align: center;">
                            <button onclick="deleteWeightEntry('${entry.date}')" style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Del</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Recalculate projection after table renders
            calculateProjection();
        }

        function drawWeightChart() {
            const setup = setupCanvas('weightChart', 350);
            if (!setup) return;
            const { canvas, ctx, width: W, height: H } = setup;
            const showMorning = document.getElementById('showMorningWeight').checked;
            const showWeekly = document.getElementById('showWeeklyAvg').checked;
            const showTrendLine = document.getElementById('showTrendLine').checked;
            const showCalories = document.getElementById('showCalories').checked;

            if (weightData.length === 0) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '16px DM Sans, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No weight data to display', W / 2, H / 2);
                return;
            }

            // Sort by date (oldest first for chart)
            const sortedData = [...weightData].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Calculate 7-day rolling averages and get calorie data from history
            sortedData.forEach((entry, index) => {
                // Get last 7 days of data (including current day)
                const last7Days = sortedData.slice(Math.max(0, index - 6), index + 1);
                
                // Get only entries with morning weights (ignore blanks)
                const weightsOnly = last7Days
                    .filter(e => e.morningWeight !== null && e.morningWeight !== undefined)
                    .map(e => e.morningWeight);
                
                if (weightsOnly.length > 0) {
                    const avg = weightsOnly.reduce((sum, w) => sum + w, 0) / weightsOnly.length;
                    entry.calculated7DayAvg = parseFloat(avg.toFixed(1));
                } else {
                    entry.calculated7DayAvg = null;
                }

                // Get calories from history if available
                const historyEntry = dayHistory.find(h => h.date === entry.date);
                entry.calories = historyEntry ? historyEntry.calories : null;
            });

            // Chart dimensions
            const padding = 60;
            const rightPadding = showCalories ? 80 : 60;
            const chartWidth = W - padding - rightPadding;
            const chartHeight = H - padding * 2;

            // Find min/max weights
            let allWeights = [];
            sortedData.forEach(entry => {
                if (showMorning && entry.morningWeight) allWeights.push(entry.morningWeight);
                if (showWeekly && entry.calculated7DayAvg) allWeights.push(entry.calculated7DayAvg);
            });

            if (allWeights.length === 0 && !showCalories) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '16px DM Sans, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data selected to display', W / 2, H / 2);
                return;
            }

            // Weight axis
            const minWeight = allWeights.length > 0 ? Math.min(...allWeights) - 2 : 0;
            const maxWeight = allWeights.length > 0 ? Math.max(...allWeights) + 2 : 200;
            const weightRange = maxWeight - minWeight;

            // Calorie axis (if enabled)
            let minCalories = 0;
            let maxCalories = 3000;
            let calorieRange = maxCalories;

            if (showCalories) {
                const calorieValues = sortedData.filter(e => e.calories).map(e => e.calories);
                if (calorieValues.length > 0) {
                    minCalories = Math.max(0, Math.min(...calorieValues) - 200);
                    maxCalories = Math.max(...calorieValues) + 200;
                    calorieRange = maxCalories - minCalories;
                }
            }

            // Draw grid lines and Y-axis labels (weight)
            if (allWeights.length > 0) {
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;
                ctx.fillStyle = '#94a3b8';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                
                for (let i = 0; i <= 5; i++) {
                    const y = padding + (chartHeight / 5) * i;
                    const weight = maxWeight - (weightRange / 5) * i;
                    
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(W - rightPadding, y);
                    ctx.stroke();
                    
                    ctx.fillText(weight.toFixed(1) + ' lb', padding - 10, y + 4);
                }
            }

            // Draw right Y-axis labels (calories)
            if (showCalories) {
                ctx.fillStyle = '#d97706';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                
                for (let i = 0; i <= 5; i++) {
                    const y = padding + (chartHeight / 5) * i;
                    const calories = maxCalories - (calorieRange / 5) * i;
                    
                    ctx.fillText(Math.round(calories) + ' cal', W - rightPadding + 10, y + 4);
                }
            }

            // Draw axes
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, H - padding);
            ctx.lineTo(W - rightPadding, H - padding);
            if (showCalories) {
                ctx.moveTo(W - rightPadding, padding);
                ctx.lineTo(W - rightPadding, H - padding);
            }
            ctx.stroke();

            // Function to get Y coordinate for weight
            const getY = (weight) => {
                return H - padding - ((weight - minWeight) / weightRange) * chartHeight;
            };

            // Function to get Y coordinate for calories
            const getCalorieY = (calories) => {
                return H - padding - ((calories - minCalories) / calorieRange) * chartHeight;
            };

            // Function to get X coordinate for index
            const getX = (index) => {
                return padding + (chartWidth / (sortedData.length - 1)) * index;
            };

            // Draw calorie bars (behind lines)
            if (showCalories) {
                ctx.fillStyle = 'rgba(245, 158, 11, 0.2)';
                sortedData.forEach((entry, i) => {
                    if (entry.calories) {
                        const x = getX(i);
                        const y = getCalorieY(entry.calories);
                        const barWidth = chartWidth / sortedData.length * 0.6;
                        ctx.fillRect(x - barWidth/2, y, barWidth, H - padding - y);
                    }
                });
            }

            // Draw morning weight line (skip blanks)
            if (showMorning) {
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let firstPoint = true;

                sortedData.forEach((entry, i) => {
                    if (entry.morningWeight) {
                        const x = getX(i);
                        const y = getY(entry.morningWeight);
                        
                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                });
                ctx.stroke();

                // Draw points
                ctx.fillStyle = '#3b82f6';
                sortedData.forEach((entry, i) => {
                    if (entry.morningWeight) {
                        const x = getX(i);
                        const y = getY(entry.morningWeight);
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            }

            // Draw 7-day average line (skip blanks)
            if (showWeekly) {
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let firstPoint = true;

                sortedData.forEach((entry, i) => {
                    if (entry.calculated7DayAvg) {
                        const x = getX(i);
                        const y = getY(entry.calculated7DayAvg);
                        
                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                });
                ctx.stroke();

                // Draw points
                ctx.fillStyle = '#10b981';
                sortedData.forEach((entry, i) => {
                    if (entry.calculated7DayAvg) {
                        const x = getX(i);
                        const y = getY(entry.calculated7DayAvg);
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            }

            // Calculate and draw trend line
            if (showTrendLine) {
                const validWeights = sortedData
                    .map((e, index) => ({ weight: e.morningWeight, index }))
                    .filter(e => e.weight);

                if (validWeights.length >= 2) {
                    const regression = calculateLinearRegression(validWeights);
                    if (regression) {
                        const { slope, intercept } = regression;

                        // Draw trend line
                        ctx.strokeStyle = '#dc2626';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();

                        // Calculate trend values for first and last points
                        const firstIndex = 0;
                        const lastIndex = sortedData.length - 1;
                        const firstTrendWeight = intercept + slope * validWeights[0].index;
                        const lastTrendWeight = intercept + slope * validWeights[validWeights.length - 1].index;

                        ctx.moveTo(getX(validWeights[0].index), getY(firstTrendWeight));
                        ctx.lineTo(getX(validWeights[validWeights.length - 1].index), getY(lastTrendWeight));
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }
            }

            // Draw goal weight line
            if (goalWeight && allWeights.length > 0) {
                ctx.strokeStyle = '#8b5cf6';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                const goalY = getY(goalWeight);
                ctx.moveTo(padding, goalY);
                ctx.lineTo(W - rightPadding, goalY);
                ctx.stroke();
                ctx.setLineDash([]);

                // Draw goal label
                ctx.fillStyle = '#8b5cf6';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`Goal: ${goalWeight} lb`, padding + 10, goalY - 5);
            }

            // Draw date labels (show every nth date to avoid crowding)
            ctx.fillStyle = '#94a3b8';
            ctx.font = '11px Arial';
            ctx.textAlign = 'center';
            const labelInterval = Math.max(1, Math.floor(sortedData.length / 10));
            
            sortedData.forEach((entry, i) => {
                if (i % labelInterval === 0 || i === sortedData.length - 1) {
                    const x = getX(i);
                    const dateLabel = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    ctx.fillText(dateLabel, x, H - padding + 20);
                }
            });

            // Add interactive hover (store data for tooltip)
            canvas._chartData = sortedData;
            canvas._getX = getX;
            canvas._getY = getY;
            canvas._getCalorieY = getCalorieY;
            canvas._minWeight = minWeight;
            canvas._maxWeight = maxWeight;
            canvas._showMorning = showMorning;
            canvas._showWeekly = showWeekly;
            canvas._showCalories = showCalories;
        }

        // Add hover effect to chart
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('weightChart');
            const tooltip = document.getElementById('weightChartTooltip');

            canvas.addEventListener('mousemove', function(e) {
                if (!canvas._chartData || canvas._chartData.length === 0) return;

                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // Find closest data point
                let closestDist = Infinity;
                let closestEntry = null;

                canvas._chartData.forEach((entry, i) => {
                    const x = canvas._getX(i);
                    
                    if (canvas._showMorning && entry.morningWeight) {
                        const y = canvas._getY(entry.morningWeight);
                        const dist = Math.sqrt((mouseX - x) ** 2 + (mouseY - y) ** 2);
                        if (dist < closestDist && dist < 20) {
                            closestDist = dist;
                            closestEntry = { ...entry, type: 'morning' };
                        }
                    }
                    
                    if (canvas._showWeekly && entry.calculated7DayAvg) {
                        const y = canvas._getY(entry.calculated7DayAvg);
                        const dist = Math.sqrt((mouseX - x) ** 2 + (mouseY - y) ** 2);
                        if (dist < closestDist && dist < 20) {
                            closestDist = dist;
                            closestEntry = { ...entry, type: 'weekly' };
                        }
                    }
                });

                if (closestEntry) {
                    const weight = closestEntry.type === 'morning' ? closestEntry.morningWeight : closestEntry.calculated7DayAvg;
                    const typeLabel = closestEntry.type === 'morning' ? 'Morning' : '7-Day Avg';
                    const color = closestEntry.type === 'morning' ? '#3b82f6' : '#10b981';
                    
                    tooltip.innerHTML = `
                        <div><strong>${closestEntry.date}</strong></div>
                        <div style="color: ${color};">${typeLabel}: ${weight} lb</div>
                        ${closestEntry.calories ? `<div style="color: var(--carbs);">Calories: ${closestEntry.calories}</div>` : ''}
                        ${closestEntry.notes ? `<div style="font-size: 0.75rem; margin-top: 4px;">${closestEntry.notes}</div>` : ''}
                    `;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                } else {
                    tooltip.style.display = 'none';
                }
            });

            canvas.addEventListener('mouseleave', function() {
                tooltip.style.display = 'none';
            });

            // Redraw all charts on window resize for responsive layout
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    redrawAllCharts();
                    drawWeightChart();
                }, 150);
            });
        });

        function deleteWeightEntry(date) {
            if (confirm(`Delete weight entry for ${date}?`)) {
                weightData = weightData.filter(entry => entry.date !== date);
                localStorage.setItem('weightData', JSON.stringify(weightData));
                syncToFirebase();
                renderWeightTable();
                drawWeightChart();
            }
        }

        function exportWeightData() {
            if (weightData.length === 0) {
                alert('No weight data to export!');
                return;
            }

            const headers = ['date', 'morning_weight_lbs', 'notes'];
            const csvRows = [
                headers.join(','),
                ...weightData.map(entry => {
                    return [
                        entry.date,
                        entry.morningWeight || '',
                        entry.notes ? `"${entry.notes}"` : ''
                    ].join(',');
                })
            ];

            const csv = csvRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `weight-data-${getLocalDateString()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importWeightData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('CSV file is empty!');
                        return;
                    }

                    const entries = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        
                        // Handle quoted notes with commas
                        const parts = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let j = 0; j < line.length; j++) {
                            const char = line[j];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                parts.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        parts.push(current.trim());

                        if (parts.length < 2) continue;

                        const dateStr = parts[0];
                        const morningWeight = parts[1];
                        const notes = parts[2] || '';

                        // Try to parse date (supports YYYY-MM-DD or other formats)
                        let date = new Date(dateStr + 'T00:00:00');
                        
                        if (isNaN(date.getTime())) continue;

                        const isoDate = getLocalDateString(date);

                        const entry = {
                            date: isoDate,
                            morningWeight: morningWeight ? parseFloat(morningWeight) : null,
                            notes: notes || null
                        };

                        if (entry.date && entry.morningWeight) {
                            entries.push(entry);
                        }
                    }

                    if (entries.length === 0) {
                        alert('No valid entries found!');
                        return;
                    }

                    // Check for duplicates and only add new entries
                    let addedCount = 0;
                    let skippedCount = 0;
                    const duplicates = [];

                    entries.forEach(newEntry => {
                        const existingEntry = weightData.find(e => e.date === newEntry.date);
                        
                        if (existingEntry) {
                            // Duplicate found - skip it
                            skippedCount++;
                            duplicates.push(newEntry.date);
                        } else {
                            // New entry - add it
                            weightData.push(newEntry);
                            addedCount++;
                        }
                    });

                    weightData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem('weightData', JSON.stringify(weightData));
                    syncToFirebase();

                    renderWeightTable();
                    drawWeightChart();

                    // Show detailed results
                    let message = `Import Complete!\n\n`;
                    message += `‚úÖ Added: ${addedCount} new entries\n`;
                    message += `‚è≠Ô∏è Skipped: ${skippedCount} duplicates\n`;
                    message += `üìä Total weight entries: ${weightData.length}`;
                    
                    if (duplicates.length > 0 && duplicates.length <= 10) {
                        message += `\n\nSkipped duplicates:\n${duplicates.join(', ')}`;
                    } else if (duplicates.length > 10) {
                        message += `\n\nSkipped duplicates:\n${duplicates.slice(0, 10).join(', ')}\n...and ${duplicates.length - 10} more`;
                    }
                    
                    alert(message);
                    event.target.value = '';
                } catch (error) {
                    alert('Error importing CSV: ' + error.message);
                    console.error(error);
                }
            };

            reader.readAsText(file);
        }

        // MANUAL UI REFRESH - Call from console if UI is broken: refreshAllUI()
        function refreshAllUI() {
            console.log('üîÑ Manually refreshing all UI...');
            console.log('Current data:', {
                foods: foodDatabase.length,
                meals: savedMeals.length,
                todayMeals: todaysMeals.length,
                history: dayHistory.length,
                weight: weightData.length
            });
            
            renderFoodList();
            updateFoodSelectors();
            renderSavedMeals();
            updateMealSelector();
            renderDayMeals();
            calculateDayTotals();
            displayGoals();
            renderHistory();
            drawHistoryChart();
            renderWeightTable();
            drawWeightChart();
            
            console.log('‚úÖ UI refresh complete!');
        }

        // EMERGENCY DATA RECOVERY FUNCTION
        // Call this from browser console if data appears lost: recoverDataFromLocalStorage()
        function recoverDataFromLocalStorage() {
            console.log('üîÑ Attempting data recovery from localStorage...');
            
            const recovered = {
                foodDatabase: localStorage.getItem('foodDatabase'),
                savedMeals: localStorage.getItem('savedMeals'),
                todaysMeals: localStorage.getItem('todaysMeals'),
                dailyGoals: localStorage.getItem('dailyGoals'),
                dayHistory: localStorage.getItem('dayHistory'),
                weightData: localStorage.getItem('weightData')
            };
            
            let recoveredCount = 0;
            
            if (recovered.foodDatabase) {
                foodDatabase = JSON.parse(recovered.foodDatabase);
                console.log('‚úÖ Recovered', foodDatabase.length, 'food items');
                recoveredCount++;
            }
            if (recovered.savedMeals) {
                savedMeals = JSON.parse(recovered.savedMeals);
                console.log('‚úÖ Recovered', savedMeals.length, 'saved meals');
                recoveredCount++;
            }
            if (recovered.todaysMeals) {
                todaysMeals = JSON.parse(recovered.todaysMeals);
                console.log('‚úÖ Recovered', todaysMeals.length, "today's meals");
                recoveredCount++;
            }
            if (recovered.dailyGoals) {
                dailyGoals = JSON.parse(recovered.dailyGoals);
                console.log('‚úÖ Recovered daily goals');
                recoveredCount++;
            }
            if (recovered.dayHistory) {
                dayHistory = JSON.parse(recovered.dayHistory);
                console.log('‚úÖ Recovered', dayHistory.length, 'history entries');
                recoveredCount++;
            }
            if (recovered.weightData) {
                weightData = JSON.parse(recovered.weightData);
                console.log('‚úÖ Recovered', weightData.length, 'weight entries');
                recoveredCount++;
            }
            
            if (recoveredCount > 0) {
                // Refresh all UI
                renderFoodList();
                updateFoodSelectors();
                renderSavedMeals();
                updateMealSelector();
                renderDayMeals();
                calculateDayTotals();
                displayGoals();
                renderHistory();
                drawHistoryChart();
                renderWeightTable();
                drawWeightChart();
                loadGoalWeight();
                
                // Hide recovery banner
                const banner = document.getElementById('emergencyRecoveryBanner');
                if (banner) banner.style.display = 'none';
                
                // Sync to Firebase
                syncToFirebase();
                
                alert(`‚úÖ Successfully recovered ${recoveredCount} data categories!\n\nRecovered:\n` + 
                      (recovered.foodDatabase ? `- ${foodDatabase.length} foods\n` : '') +
                      (recovered.savedMeals ? `- ${savedMeals.length} saved meals\n` : '') +
                      (recovered.todaysMeals ? `- ${todaysMeals.length} today's meals\n` : '') +
                      (recovered.dailyGoals ? `- Daily goals\n` : '') +
                      (recovered.dayHistory ? `- ${dayHistory.length} history entries\n` : '') +
                      (recovered.weightData ? `- ${weightData.length} weight entries\n` : '') +
                      '\nYour data has been restored and synced to cloud!');
                console.log('‚úÖ Data recovery complete! Synced to Firebase.');
            } else {
                alert('‚ùå No data found in localStorage to recover.');
                console.log('‚ùå No data found in localStorage');
            }
        }

        // Goal Weight and Trend Line Functions
        function setGoalWeight() {
            const goal = parseFloat(document.getElementById('goalWeight').value);
            if (!goal || goal <= 0) {
                alert('Please enter a valid goal weight');
                return;
            }

            goalWeight = goal;
            localStorage.setItem('goalWeight', goalWeight.toString());
            
            calculateProjection();
            drawWeightChart();
        }

        function clearGoalWeight() {
            goalWeight = null;
            localStorage.removeItem('goalWeight');
            document.getElementById('goalWeight').value = '';
            document.getElementById('goalProjection').style.display = 'none';
            drawWeightChart();
        }

        function calculateLinearRegression(data) {
            // Calculate linear regression for trend line
            // Returns {slope, intercept}
            if (data.length < 2) return null;

            const n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

            data.forEach((point, index) => {
                const x = index; // Use index as x (time)
                const y = point.weight;
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumX2 += x * x;
            });

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            return { slope, intercept };
        }

        function calculateProjection() {
            if (!goalWeight || weightData.length < 2) {
                document.getElementById('goalProjection').style.display = 'none';
                return;
            }

            // Get weights with valid morning weights only
            const validWeights = weightData
                .filter(e => e.morningWeight)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map((e, index) => ({ date: e.date, weight: e.morningWeight, index }));

            if (validWeights.length < 2) {
                document.getElementById('goalProjection').style.display = 'none';
                return;
            }

            // Calculate trend line
            const regression = calculateLinearRegression(validWeights);
            if (!regression) return;

            const { slope, intercept } = regression;

            // Get current weight (most recent)
            const currentWeight = validWeights[validWeights.length - 1].weight;
            const currentDate = new Date(validWeights[validWeights.length - 1].date);

            // Check if goal is achievable based on trend
            if ((goalWeight > currentWeight && slope <= 0) || (goalWeight < currentWeight && slope >= 0)) {
                // Trend is going opposite direction
                document.getElementById('goalProjection').style.display = 'block';
                document.getElementById('targetWeight').textContent = goalWeight + ' lb';
                document.getElementById('targetWeight').style.color = '#8b5cf6';
                document.getElementById('projectedDate').textContent = 'Not aligned with trend';
                document.getElementById('projectedDate').style.color = '#dc2626';
                document.getElementById('projectedDays').textContent = slope > 0 ? 'Gaining' : 'Losing';
                document.getElementById('weightToGo').textContent = `${Math.abs(currentWeight - goalWeight).toFixed(1)} lb to go`;
                document.getElementById('trendRate').textContent = `Trend: ${slope > 0 ? '+' : ''}${slope.toFixed(3)} lb/day (${(slope * 7).toFixed(2)} lb/week)`;
                return;
            }

            // Calculate days to reach goal
            // Current predicted weight at last index: intercept + slope * lastIndex
            const lastIndex = validWeights.length - 1;
            const currentPredicted = intercept + slope * lastIndex;
            const weightDiff = goalWeight - currentPredicted;
            const daysNeeded = Math.abs(weightDiff / slope);

            const projectedDate = new Date(currentDate);
            projectedDate.setDate(projectedDate.getDate() + Math.round(daysNeeded));

            // Display projection
            document.getElementById('goalProjection').style.display = 'block';
            document.getElementById('targetWeight').textContent = goalWeight + ' lb';
            document.getElementById('targetWeight').style.color = '#8b5cf6';
            document.getElementById('projectedDate').textContent = projectedDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            document.getElementById('projectedDate').style.color = '#10b981';
            
            const daysFromNow = Math.round((projectedDate - new Date()) / (1000 * 60 * 60 * 24));
            document.getElementById('projectedDays').textContent = daysFromNow + ' days';
            document.getElementById('weightToGo').textContent = `${Math.abs(currentWeight - goalWeight).toFixed(1)} lb to go`;
            document.getElementById('trendRate').textContent = `Trend: ${slope > 0 ? '+' : ''}${slope.toFixed(3)} lb/day (${(slope * 7).toFixed(2)} lb/week)`;
        }

        function loadGoalWeight() {
            if (goalWeight) {
                document.getElementById('goalWeight').value = goalWeight;
                calculateProjection();
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('‚úÖ Service Worker registered'))
                .catch(err => console.log('SW registration failed:', err));
        }
    </script>

</body>
</html>
